<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>QuizBlast âš¡ äº’å‹•æ•™è‚²è¨“ç·´</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d1a;
  --surface: #161628;
  --surface2: #1e1e38;
  --border: rgba(255,255,255,0.08);
  --primary: #7c6dfa;
  --primary-glow: rgba(124,109,250,0.35);
  --ans-a: #e8344a;
  --ans-b: #1a9bfc;
  --ans-c: #f5a623;
  --ans-d: #2eb872;
  --ans-a-dark: #c02336;
  --ans-b-dark: #0f7ed4;
  --ans-c-dark: #d4891a;
  --ans-d-dark: #22965b;
  --yellow: #ffe066;
  --cyan: #4fd1f5;
  --pink: #ff7eb6;
  --text: #ffffff;
  --text-muted: rgba(255,255,255,0.55);
  --radius: 16px;
  --radius-sm: 10px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Nunito', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€â”€ Animated BG Stars â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.18) 0%, transparent 100%),
    radial-gradient(1px 1px at 60% 70%, rgba(255,255,255,0.12) 0%, transparent 100%),
    radial-gradient(1px 1px at 80% 15%, rgba(255,255,255,0.15) 0%, transparent 100%),
    radial-gradient(1px 1px at 10% 80%, rgba(255,255,255,0.10) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 45% 55%, rgba(200,180,255,0.2) 0%, transparent 100%);
  pointer-events: none;
  z-index: 0;
}
body::after {
  content: '';
  position: fixed;
  bottom: -200px; left: -200px;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(124,109,250,0.12) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
  animation: floatGlow 8s ease-in-out infinite alternate;
}
@keyframes floatGlow {
  from { transform: translate(0,0); }
  to { transform: translate(60px,-40px); }
}

/* â”€â”€â”€ Screens â”€â”€â”€ */
.screen {
  position: relative; z-index: 1;
  min-height: 100vh;
  display: none;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}
.screen.active { display: flex; }

/* â”€â”€â”€ Heading â”€â”€â”€ */
.logo {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(2.2rem, 6vw, 3.5rem);
  letter-spacing: 1px;
  background: linear-gradient(135deg, var(--cyan) 0%, var(--primary) 50%, var(--pink) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
  filter: drop-shadow(0 0 20px rgba(124,109,250,0.5));
  margin-bottom: 4px;
}
.logo-sub {
  color: var(--text-muted);
  font-size: 0.85rem;
  font-weight: 600;
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-bottom: 32px;
}

/* â”€â”€â”€ Cards â”€â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px;
  width: 100%;
  max-width: 560px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--cyan));
  opacity: 0.7;
}

/* â”€â”€â”€ Buttons â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px 28px;
  border: none; border-radius: var(--radius-sm);
  font-family: 'Nunito', sans-serif;
  font-weight: 800;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: none;
  letter-spacing: 0.3px;
  position: relative;
  overflow: hidden;
}
.btn::after {
  content: '';
  position: absolute; inset: 0;
  background: rgba(255,255,255,0.15);
  opacity: 0;
  transition: opacity 0.2s;
  pointer-events: none;
}
.btn:hover::after { opacity: 1; }
.btn:active { transform: scale(0.97); }

.btn-primary {
  background: linear-gradient(135deg, var(--primary), #9b6dfa);
  color: white;
  box-shadow: 0 4px 20px rgba(124,109,250,0.4);
}
.btn-primary:hover { box-shadow: 0 6px 28px rgba(124,109,250,0.6); transform: translateY(-1px); }

.btn-secondary {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-secondary:hover { border-color: var(--primary); }

.btn-danger {
  background: linear-gradient(135deg, var(--ans-a), var(--ans-a-dark));
  color: white;
  box-shadow: 0 4px 20px rgba(232,52,74,0.3);
}
.btn-success {
  background: linear-gradient(135deg, var(--ans-d), var(--ans-d-dark));
  color: white;
  box-shadow: 0 4px 20px rgba(46,184,114,0.3);
}
.btn-lg { padding: 18px 40px; font-size: 1.15rem; border-radius: 14px; }
.btn-full { width: 100%; }

/* â”€â”€â”€ Inputs â”€â”€â”€ */
.input-field {
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'Nunito', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  padding: 12px 16px;
  width: 100%;
  transition: border-color 0.2s;
  outline: none;
}
.input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
.input-field::placeholder { color: var(--text-muted); font-weight: 600; }

label {
  display: block;
  font-size: 0.8rem;
  font-weight: 800;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 6px;
}

/* â”€â”€â”€ Home Screen â”€â”€â”€ */
#screen-home {
  justify-content: center;
  text-align: center;
  gap: 0;
}
.mode-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 16px; width: 100%; max-width: 560px; margin-top: 8px;
}
.mode-card {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 32px 20px;
  cursor: pointer;
  transition: all 0.25s ease;
  text-align: center;
}
.mode-card:hover {
  border-color: var(--primary);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(124,109,250,0.3);
}
.mode-card .icon { font-size: 3rem; margin-bottom: 12px; display: block; }
.mode-card h3 {
  font-family: 'Fredoka One', cursive;
  font-size: 1.3rem; margin-bottom: 6px;
}
.mode-card p { font-size: 0.82rem; color: var(--text-muted); font-weight: 600; }

/* â”€â”€â”€ Host Setup â”€â”€â”€ */
.question-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
.q-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer;
  transition: border-color 0.2s;
}
.q-item:hover { border-color: var(--primary); }
.q-item .q-num {
  background: var(--primary);
  color: white;
  border-radius: 50%;
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem; font-weight: 900;
  flex-shrink: 0;
}
.q-item .q-text { flex: 1; font-size: 0.9rem; font-weight: 700; }
.q-item .q-del {
  color: var(--ans-a);
  cursor: pointer;
  padding: 4px;
  opacity: 0.6;
  transition: opacity 0.2s;
  background: none; border: none; font-size: 1.1rem;
}
.q-item .q-del:hover { opacity: 1; }

.q-editor {
  background: var(--surface2);
  border: 1px solid var(--primary);
  border-radius: var(--radius);
  padding: 20px;
  margin-top: 8px;
}
.options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.opt-input-wrap {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  cursor: pointer;
  transition: border-color 0.2s;
}
.opt-input-wrap.correct-opt { border-color: var(--ans-d); }
.opt-input-wrap input[type="text"] {
  background: none; border: none; outline: none;
  color: var(--text); font-family: 'Nunito', sans-serif;
  font-weight: 700; font-size: 0.9rem; flex: 1;
}
.opt-badge {
  width: 22px; height: 22px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.65rem; font-weight: 900;
  color: white; flex-shrink: 0;
  transition: transform 0.2s;
}
.opt-badge.a { background: var(--ans-a); }
.opt-badge.b { background: var(--ans-b); }
.opt-badge.c { background: var(--ans-c); }
.opt-badge.d { background: var(--ans-d); }
.correct-label {
  font-size: 0.7rem; font-weight: 800;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--ans-d); margin-top: 6px; display: none;
}
.opt-input-wrap.correct-opt .correct-label { display: block; }

.time-select {
  display: flex; gap: 8px; flex-wrap: wrap;
}
.time-btn {
  padding: 8px 14px;
  border-radius: 8px;
  border: 2px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-family: 'Nunito', sans-serif;
  font-weight: 800;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}
.time-btn.active { border-color: var(--cyan); background: rgba(79,209,245,0.15); color: var(--cyan); }

/* â”€â”€â”€ QR Code Area â”€â”€â”€ */
.qr-area {
  background: white;
  border-radius: 14px;
  padding: 14px;
  display: inline-block;
  margin: 12px auto;
}
#qrcode canvas, #qrcode img { display: block; }
.join-url {
  font-size: 0.75rem;
  color: var(--text-muted);
  word-break: break-all;
  margin-top: 8px;
  text-align: center;
}

/* â”€â”€â”€ Lobby â”€â”€â”€ */
.players-grid {
  display: flex; flex-wrap: wrap; gap: 10px;
  justify-content: center;
}
.player-chip {
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: 50px;
  padding: 8px 18px;
  font-weight: 800;
  font-size: 0.9rem;
  display: flex; align-items: center; gap: 8px;
  animation: popIn 0.3s ease;
}
@keyframes popIn {
  from { transform: scale(0.5); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.player-avatar {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.8rem;
  font-weight: 900;
  color: white;
}

/* â”€â”€â”€ Question Screen (Host) â”€â”€â”€ */
.q-progress {
  display: flex; gap: 6px; margin-bottom: 20px;
}
.q-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--border);
  transition: background 0.3s;
}
.q-dot.done { background: var(--primary); }
.q-dot.active { background: var(--yellow); }

.question-box {
  background: var(--surface2);
  border-radius: var(--radius);
  padding: 28px;
  text-align: center;
  font-family: 'Fredoka One', cursive;
  font-size: clamp(1.2rem, 3vw, 1.7rem);
  line-height: 1.4;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  width: 100%;
}

/* â”€â”€â”€ Countdown â”€â”€â”€ */
.timer-wrap {
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 20px;
}
.timer-ring {
  position: relative;
  width: 80px; height: 80px;
}
.timer-ring svg { transform: rotate(-90deg); }
.timer-ring circle {
  fill: none;
  stroke-width: 6;
  stroke-linecap: round;
  cx: 40; cy: 40; r: 34;
  stroke-dasharray: 213.6;
}
.timer-bg { stroke: var(--surface2); }
.timer-prog { stroke: var(--cyan); transition: stroke-dashoffset 0.1s linear; stroke-dashoffset: 0; }
.timer-num {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Fredoka One', cursive;
  font-size: 1.8rem;
  color: var(--cyan);
}
.timer-ring.urgent .timer-prog { stroke: var(--ans-a); }
.timer-ring.urgent .timer-num { color: var(--ans-a); animation: shake 0.3s ease infinite; }

/* â”€â”€â”€ Answer Buttons (Host Display) â”€â”€â”€ */
.answers-host {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 12px; width: 100%;
}
.ans-btn-host {
  border-radius: 14px;
  padding: 18px 14px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.05rem;
  color: white;
  display: flex; align-items: center; gap: 10px;
  border: none;
  position: relative;
  overflow: hidden;
  transition: opacity 0.3s;
}
.ans-btn-host[data-opt="0"] { background: linear-gradient(135deg, var(--ans-a), var(--ans-a-dark)); }
.ans-btn-host[data-opt="1"] { background: linear-gradient(135deg, var(--ans-b), var(--ans-b-dark)); }
.ans-btn-host[data-opt="2"] { background: linear-gradient(135deg, var(--ans-c), var(--ans-c-dark)); }
.ans-btn-host[data-opt="3"] { background: linear-gradient(135deg, var(--ans-d), var(--ans-d-dark)); }
.ans-shape {
  width: 32px; height: 32px;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
}

/* â”€â”€â”€ Answer Buttons (Player) â”€â”€â”€ */
.answers-player {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 14px; width: 100%;
}
.ans-btn-player {
  border-radius: 16px;
  padding: 24px 14px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.05rem;
  color: white;
  border: none;
  cursor: pointer;
  display: flex; flex-direction: column; align-items: center; gap: 10px;
  transition: all 0.15s ease;
  position: relative;
  overflow: hidden;
}
.ans-btn-player::after {
  content: '';
  position: absolute; inset: 0;
  background: rgba(255,255,255,0);
  transition: background 0.15s;
  pointer-events: none;
}
.ans-btn-player:hover::after { background: rgba(255,255,255,0.12); }
.ans-btn-player:active { transform: scale(0.95); }
.ans-btn-player[data-opt="0"] { background: linear-gradient(135deg, var(--ans-a), var(--ans-a-dark)); box-shadow: 0 6px 20px rgba(232,52,74,0.4); }
.ans-btn-player[data-opt="1"] { background: linear-gradient(135deg, var(--ans-b), var(--ans-b-dark)); box-shadow: 0 6px 20px rgba(26,155,252,0.4); }
.ans-btn-player[data-opt="2"] { background: linear-gradient(135deg, var(--ans-c), var(--ans-c-dark)); box-shadow: 0 6px 20px rgba(245,166,35,0.4); }
.ans-btn-player[data-opt="3"] { background: linear-gradient(135deg, var(--ans-d), var(--ans-d-dark)); box-shadow: 0 6px 20px rgba(46,184,114,0.4); }
.ans-btn-player .shape-icon { font-size: 2rem; }
.ans-btn-player.disabled { opacity: 0.35; pointer-events: none; }
.ans-btn-player.selected { transform: scale(1.04); }
.ans-btn-player.selected::after { background: rgba(255,255,255,0.25); }

/* â”€â”€â”€ Results Screen â”€â”€â”€ */
.correct-banner {
  background: linear-gradient(135deg, var(--ans-d), var(--ans-d-dark));
  border-radius: var(--radius);
  padding: 20px 28px;
  text-align: center;
  margin-bottom: 20px;
  width: 100%;
}
.correct-banner h2 { font-family: 'Fredoka One', cursive; font-size: 1.5rem; }
.incorrect-banner {
  background: linear-gradient(135deg, var(--ans-a), var(--ans-a-dark));
  border-radius: var(--radius);
  padding: 20px 28px;
  text-align: center;
  margin-bottom: 20px;
  width: 100%;
}

.leaderboard { list-style: none; display: flex; flex-direction: column; gap: 10px; width: 100%; }
.lb-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 18px;
  display: flex; align-items: center; gap: 14px;
  transition: transform 0.3s;
  animation: slideIn 0.4s ease both;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}
.lb-rank {
  font-family: 'Fredoka One', cursive;
  font-size: 1.3rem;
  width: 36px; text-align: center;
  flex-shrink: 0;
}
.lb-rank.top-1 { color: var(--yellow); }
.lb-rank.top-2 { color: #c0c0c0; }
.lb-rank.top-3 { color: #cd7f32; }
.lb-name { flex: 1; font-weight: 800; font-size: 0.95rem; }
.lb-score {
  font-family: 'Fredoka One', cursive;
  font-size: 1.2rem;
  color: var(--cyan);
}
.lb-delta {
  font-size: 0.75rem;
  font-weight: 800;
  color: var(--ans-d);
  background: rgba(46,184,114,0.15);
  padding: 3px 8px;
  border-radius: 20px;
}

/* â”€â”€â”€ Player feedback â”€â”€â”€ */
.feedback-wrap {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  flex: 1; width: 100%; text-align: center;
}
.feedback-icon { font-size: 5rem; margin-bottom: 12px; animation: bounceIn 0.5s ease; }
@keyframes bounceIn {
  0% { transform: scale(0); }
  60% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.points-earned {
  font-family: 'Fredoka One', cursive;
  font-size: 3.5rem;
  color: var(--yellow);
  animation: countUp 0.8s ease;
}
@keyframes countUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.player-rank-badge {
  background: var(--surface2);
  border: 2px solid var(--primary);
  border-radius: 50px;
  padding: 10px 24px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.2rem;
  margin-top: 10px;
  color: var(--cyan);
}

/* â”€â”€â”€ Final Screen â”€â”€â”€ */
.podium {
  display: flex; align-items: flex-end; justify-content: center;
  gap: 12px; margin: 20px 0;
}
.podium-item {
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  width: 100px;
}
.podium-base {
  width: 100%; border-radius: 8px 8px 0 0;
  display: flex; align-items: flex-end; justify-content: center;
  padding-bottom: 10px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.8rem;
}
.podium-base.first { height: 120px; background: linear-gradient(180deg, rgba(255,224,102,0.3), rgba(255,224,102,0.15)); border: 1px solid rgba(255,224,102,0.4); }
.podium-base.second { height: 90px; background: linear-gradient(180deg, rgba(192,192,192,0.3), rgba(192,192,192,0.15)); border: 1px solid rgba(192,192,192,0.4); }
.podium-base.third { height: 70px; background: linear-gradient(180deg, rgba(205,127,50,0.3), rgba(205,127,50,0.15)); border: 1px solid rgba(205,127,50,0.4); }
.podium-name { font-weight: 900; font-size: 0.85rem; text-align: center; max-width: 100px; word-break: break-word; }
.podium-score { font-family: 'Fredoka One', cursive; font-size: 1rem; color: var(--cyan); }

/* â”€â”€â”€ Progress bar (answered count) â”€â”€â”€ */
.answered-bar-wrap {
  background: var(--surface2);
  border-radius: 50px;
  height: 8px;
  width: 100%;
  overflow: hidden;
  margin: 8px 0;
}
.answered-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--cyan));
  border-radius: 50px;
  transition: width 0.5s ease;
}
.answered-count {
  font-size: 0.8rem;
  color: var(--text-muted);
  font-weight: 700;
  text-align: center;
}

/* â”€â”€â”€ Utility â”€â”€â”€ */
.text-center { text-align: center; }
.section-title {
  font-family: 'Fredoka One', cursive;
  font-size: 1.4rem;
  margin-bottom: 16px;
}
.section-subtitle {
  color: var(--text-muted);
  font-size: 0.85rem;
  font-weight: 700;
  margin-bottom: 12px;
}
.row { display: flex; gap: 10px; }
.flex-1 { flex: 1; }
.mt-8 { margin-top: 8px; }
.mt-16 { margin-top: 16px; }
.mt-24 { margin-top: 24px; }
.gap-8 { gap: 8px; }
.separator {
  border: none;
  border-top: 1px solid var(--border);
  margin: 18px 0;
}
.badge {
  display: inline-flex; align-items: center;
  padding: 4px 12px;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 800;
  letter-spacing: 0.5px;
}
.badge-primary { background: rgba(124,109,250,0.2); color: var(--primary); border: 1px solid rgba(124,109,250,0.4); }
.badge-success { background: rgba(46,184,114,0.2); color: var(--ans-d); border: 1px solid rgba(46,184,114,0.4); }
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--surface2);
  border: 1px solid var(--primary);
  border-radius: 50px;
  padding: 10px 24px;
  font-weight: 700;
  font-size: 0.9rem;
  z-index: 999;
  animation: toastIn 0.3s ease;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  white-space: nowrap;
}
@keyframes toastIn {
  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}
@keyframes shake {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-3deg); }
  75% { transform: rotate(3deg); }
}
.waiting-anim {
  display: flex; gap: 6px; justify-content: center; margin: 20px 0;
}
.waiting-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--primary);
  animation: waitDot 1.2s ease-in-out infinite;
}
.waiting-dot:nth-child(2) { animation-delay: 0.2s; }
.waiting-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes waitDot {
  0%, 100% { opacity: 0.2; transform: translateY(0); }
  50% { opacity: 1; transform: translateY(-8px); }
}

/* â”€â”€â”€ Confetti â”€â”€â”€ */
.confetti-piece {
  position: fixed;
  width: 10px; height: 12px;
  border-radius: 2px;
  top: -20px;
  animation: confettiFall linear forwards;
  z-index: 999;
  pointer-events: none;
}
@keyframes confettiFall {
  to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: HOME -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen active" id="screen-home">
  <div style="text-align:center; margin-bottom:32px; margin-top:12vh">
    <div class="logo">âš¡ QuizBlast</div>
    <div class="logo-sub">äº’å‹•æ•™è‚²è¨“ç·´å¹³å°</div>
  </div>
  <div class="mode-grid">
    <div class="mode-card" onclick="enterHostMode()">
      <span class="icon">ğŸ®</span>
      <h3>ä¸»æŒéŠæˆ²</h3>
      <p>å»ºç«‹é¡Œç›®<br>ç®¡ç†éŠæˆ²æµç¨‹</p>
    </div>
    <div class="mode-card" onclick="showScreen('screen-player-join')">
      <span class="icon">ğŸ™‹</span>
      <h3>åŠ å…¥éŠæˆ²</h3>
      <p>å¡«å¯«å§“å<br>é–‹å§‹ç«¶è³½ç­”é¡Œ</p>
    </div>
  </div>
  <p class="mt-16" style="color:var(--text-muted);font-size:0.8rem;text-align:center">
    ä¸»æŒäººæƒæ QR Code å¯è®“æ‰€æœ‰äººå¿«é€ŸåŠ å…¥
  </p>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: HOST SETUP -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-host-setup">
  <div style="text-align:center;margin-bottom:24px;padding-top:20px">
    <div class="logo" style="font-size:2rem">âš¡ QuizBlast</div>
    <span class="badge badge-primary" style="margin-top:6px">ä¸»æŒäººæ¨¡å¼</span>
  </div>

  <div class="card" style="max-width:760px">
    <div class="section-title">ğŸ“‹ é¡Œç›®ç®¡ç†</div>

    <div id="q-list-container">
      <ul class="question-list" id="q-list"></ul>
    </div>

    <div class="q-editor mt-16" id="q-editor">
      <div class="section-subtitle">â• æ–°å¢ / ç·¨è¼¯é¡Œç›®</div>
      <label>å•é¡Œ</label>
      <input class="input-field" id="ed-question" type="text" placeholder="è¼¸å…¥å•é¡Œå…§å®¹...">

      <div class="options-grid mt-8" id="ed-options-grid">
        <!-- filled by JS -->
      </div>
      <p style="font-size:0.78rem;color:var(--text-muted);margin-top:8px">ğŸ’¡ é»æ“Šé¸é …åˆ—å³å¯è¨­ç‚ºæ­£ç¢ºç­”æ¡ˆ</p>

      <div style="margin-top:14px">
        <label>ä½œç­”æ™‚é–“</label>
        <div class="time-select" id="ed-time-btns">
          <button class="time-btn" data-t="10">10ç§’</button>
          <button class="time-btn active" data-t="20">20ç§’</button>
          <button class="time-btn" data-t="30">30ç§’</button>
          <button class="time-btn" data-t="60">60ç§’</button>
        </div>
      </div>
      <div class="row mt-16" style="gap:10px">
        <button class="btn btn-primary flex-1" onclick="saveCurrentQuestion()">ğŸ’¾ å„²å­˜é¡Œç›®</button>
        <button class="btn btn-secondary" onclick="resetEditor()">ğŸ”„ æ¸…é™¤</button>
      </div>
    </div>

    <hr class="separator">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <button class="btn btn-secondary" onclick="loadDefaultQuestions()">ğŸ“¦ è¼‰å…¥ç¯„ä¾‹é¡Œç›®</button>
      <span style="color:var(--text-muted);font-size:0.8rem">å¿«é€Ÿé–‹å§‹æ•™è‚²è¨“ç·´</span>
    </div>
  </div>

  <div class="card" style="max-width:760px">
    <div class="section-title">ğŸ”— åŠ å…¥é€£çµ & QR Code</div>
    <p class="section-subtitle">è®“åŒäº‹æƒæä»¥ä¸‹ QR Code æˆ–é–‹å•Ÿé€£çµåŠ å…¥éŠæˆ²</p>
    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="qr-area"><div id="qrcode"></div></div>
      <p class="join-url" id="join-url-text">â€”</p>
    </div>
  </div>

  <div class="card" style="max-width:760px">
    <button class="btn btn-primary btn-full btn-lg" id="btn-start-lobby" onclick="startLobby()">
      ğŸš€ é–‹æ”¾åŠ å…¥ç­‰å¾…å®¤
    </button>
  </div>

  <button class="btn btn-secondary mt-8" onclick="showScreen('screen-home')">â† è¿”å›</button>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: HOST LOBBY (Waiting Room) -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-host-lobby">
  <div style="text-align:center;padding-top:24px;margin-bottom:20px">
    <div class="logo" style="font-size:2rem">âš¡ QuizBlast</div>
    <div class="logo-sub">ç­‰å¾…å®¤é–‹æ”¾ä¸­</div>
  </div>

  <div class="card" style="max-width:700px;text-align:center">
    <div class="qr-area" style="margin:0 auto 12px"><div id="qrcode2"></div></div>
    <p class="join-url" id="join-url-text2">â€”</p>
    <p style="font-size:0.82rem;color:var(--text-muted);margin-top:8px">
      æƒæ QR Code æˆ–é–‹å•Ÿé€£çµå¾Œè¼¸å…¥å§“ååŠ å…¥
    </p>
  </div>

  <div class="card" style="max-width:700px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="section-title" style="margin:0">ğŸ‘¥ å·²åŠ å…¥ç©å®¶</div>
      <span class="badge badge-success" id="player-count-badge">0 äºº</span>
    </div>
    <div class="players-grid" id="lobby-players"></div>
    <div class="waiting-anim mt-16">
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
    </div>
    <p style="text-align:center;color:var(--text-muted);font-size:0.82rem">ç­‰å¾…ç©å®¶åŠ å…¥ä¸­...</p>
  </div>

  <div class="card" style="max-width:700px">
    <button class="btn btn-primary btn-full btn-lg" id="btn-start-game" onclick="startGame()">
      â–¶ é–‹å§‹éŠæˆ²
    </button>
    <p style="text-align:center;font-size:0.78rem;color:var(--text-muted);margin-top:8px">
      å»ºè­°ç­‰æ‰€æœ‰äººåŠ å…¥å¾Œå†é–‹å§‹
    </p>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: HOST QUESTION -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-host-question">
  <div style="width:100%;max-width:800px;display:flex;flex-direction:column;align-items:center;padding-top:16px">
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;margin-bottom:16px">
      <span id="hq-label" class="badge badge-primary">ç¬¬ 1 / 5 é¡Œ</span>
      <div class="timer-wrap" style="margin:0">
        <div class="timer-ring" id="host-timer-ring">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle class="timer-bg" cx="40" cy="40" r="34"/>
            <circle class="timer-prog" id="host-timer-circle" cx="40" cy="40" r="34"/>
          </svg>
          <div class="timer-num" id="host-timer-num">20</div>
        </div>
      </div>
    </div>

    <div class="q-progress" id="hq-progress"></div>

    <div class="question-box" id="hq-text">å•é¡Œå…§å®¹</div>

    <div class="answered-count" id="hq-answered-count">0 / 0 äººå·²ä½œç­”</div>
    <div class="answered-bar-wrap mt-8" style="max-width:400px">
      <div class="answered-bar" id="hq-answered-bar" style="width:0%"></div>
    </div>

    <div class="answers-host mt-16" id="hq-answers"></div>

    <button class="btn btn-primary btn-lg mt-24" id="btn-end-q" onclick="endQuestion()" style="min-width:200px">
      â­ é¡¯ç¤ºçµæœ
    </button>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: HOST RESULTS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-host-results">
  <div style="width:100%;max-width:700px;padding-top:20px">
    <div class="section-title text-center">ğŸ“Š æœ¬é¡Œçµæœ</div>
    <div id="hr-correct-ans" class="correct-banner" style="margin-bottom:16px"></div>
    <div class="section-subtitle">æ’è¡Œæ¦œ</div>
    <ul class="leaderboard" id="host-leaderboard"></ul>
    <div class="mt-24 text-center" style="display:flex;gap:12px;justify-content:center">
      <button class="btn btn-primary btn-lg" id="btn-next-q" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â†’</button>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: HOST FINAL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-host-final">
  <div style="text-align:center;padding-top:24px;margin-bottom:16px">
    <div class="logo">ğŸ† æœ€çµ‚çµæœ</div>
    <div class="logo-sub">éŠæˆ²çµæŸï¼</div>
  </div>
  <div style="max-width:700px;width:100%">
    <div class="podium" id="final-podium"></div>
    <ul class="leaderboard" id="host-final-leaderboard"></ul>
    <div class="text-center mt-24">
      <button class="btn btn-primary btn-lg" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: PLAYER JOIN -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-player-join">
  <div style="text-align:center;margin-bottom:32px;padding-top:12vh">
    <div class="logo">âš¡ QuizBlast</div>
    <div class="logo-sub">åŠ å…¥éŠæˆ²</div>
  </div>
  <div class="card">
    <div class="section-title">ğŸ‘¤ è¼¸å…¥ä½ çš„å§“å</div>
    <label>å§“å</label>
    <input class="input-field" id="player-name-input" type="text" placeholder="ä¾‹ï¼šç‹å°æ˜" maxlength="20"
      onkeydown="if(event.key==='Enter') joinGame()">
    <button class="btn btn-primary btn-full btn-lg mt-16" onclick="joinGame()">
      ğŸš€ åŠ å…¥éŠæˆ²ï¼
    </button>
  </div>
  <button class="btn btn-secondary mt-8" onclick="showScreen('screen-home')">â† è¿”å›</button>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: PLAYER LOBBY (waiting) -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-player-lobby">
  <div style="text-align:center;padding-top:14vh">
    <div class="logo">âš¡ QuizBlast</div>
    <div style="margin-top:10px">
      <span class="badge badge-success" id="plobby-name-badge">ç©å®¶åç¨±</span>
    </div>
    <div style="margin-top:32px;font-family:'Fredoka One',cursive;font-size:1.3rem;color:var(--text-muted)">
      ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²
    </div>
    <div class="waiting-anim mt-16">
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
    </div>
    <p style="font-size:0.8rem;color:var(--text-muted);margin-top:16px">ä¸»æŒäººå®£å¸ƒé–‹å§‹å¾Œå°‡è‡ªå‹•é€²å…¥ä½œç­”</p>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: PLAYER QUESTION -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-player-question">
  <div style="width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center;padding-top:16px">
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;margin-bottom:16px">
      <span id="pq-label" class="badge badge-primary">ç¬¬ 1 é¡Œ</span>
      <div class="timer-wrap" style="margin:0">
        <div class="timer-ring" id="player-timer-ring">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle class="timer-bg" cx="40" cy="40" r="34"/>
            <circle class="timer-prog" id="player-timer-circle" cx="40" cy="40" r="34"/>
          </svg>
          <div class="timer-num" id="player-timer-num">20</div>
        </div>
      </div>
    </div>

    <div class="question-box" id="pq-text">å•é¡Œå…§å®¹</div>
    <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:14px;font-weight:700">è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ</p>
    <div class="answers-player" id="pq-answers"></div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: PLAYER FEEDBACK -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-player-feedback">
  <div class="feedback-wrap">
    <div class="feedback-icon" id="pf-icon">âœ…</div>
    <div style="font-family:'Fredoka One',cursive;font-size:1.5rem;margin-bottom:8px" id="pf-text">ç­”å°äº†ï¼</div>
    <div class="points-earned" id="pf-points">+850</div>
    <div style="font-size:0.85rem;color:var(--text-muted);font-weight:700;margin-bottom:16px">æœ¬é¡Œå¾—åˆ†</div>
    <div class="player-rank-badge" id="pf-rank">ç›®å‰æ’åï¼šç¬¬ 2 å</div>
    <div class="waiting-anim mt-24">
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
    </div>
    <p style="font-size:0.8rem;color:var(--text-muted);margin-top:8px">ç­‰å¾…ä¸‹ä¸€é¡Œ...</p>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: PLAYER RESULTS (leaderboard) -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-player-results">
  <div style="width:100%;max-width:600px;padding-top:20px">
    <div class="section-title text-center" id="pr-q-result"></div>
    <div id="pr-feedback-banner" style="border-radius:14px;padding:16px 20px;text-align:center;margin-bottom:16px"></div>
    <div class="section-subtitle text-center">ğŸ† æ’è¡Œæ¦œ</div>
    <ul class="leaderboard" id="player-leaderboard"></ul>
    <div class="waiting-anim mt-16">
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
      <div class="waiting-dot"></div>
    </div>
    <p style="text-align:center;font-size:0.8rem;color:var(--text-muted);margin-top:8px">ç­‰å¾…ä¸‹ä¸€é¡Œ...</p>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCREEN: PLAYER FINAL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="screen" id="screen-player-final">
  <div style="text-align:center;padding-top:12vh">
    <div class="logo">ğŸ† éŠæˆ²çµæŸ</div>
    <div class="logo-sub" id="pfinal-sub">æ„Ÿè¬åƒèˆ‡ï¼</div>
  </div>
  <div style="max-width:600px;width:100%">
    <div class="card text-center mt-16">
      <div id="pfinal-rank-icon" style="font-size:4rem;margin-bottom:12px">ğŸ‰</div>
      <div style="font-family:'Fredoka One',cursive;font-size:1.3rem;margin-bottom:4px" id="pfinal-msg">å¤ªæ£’äº†ï¼</div>
      <div class="points-earned" id="pfinal-score">0</div>
      <div style="font-size:0.85rem;color:var(--text-muted);font-weight:700">æœ€çµ‚å¾—åˆ†</div>
      <div class="player-rank-badge mt-16" id="pfinal-rank">æœ€çµ‚æ’åï¼šç¬¬ 1 å</div>
    </div>
    <ul class="leaderboard mt-16" id="player-final-leaderboard"></ul>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â”€â”€â”€ Storage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const USE_SHARED = (typeof window.storage !== 'undefined');

// BroadcastChannel for cross-tab real-time sync (local mode)
let _bc = null;
try {
  if (!USE_SHARED) {
    _bc = new BroadcastChannel('quizblast_sync');
    _bc.onmessage = () => {
      // Trigger an immediate poll tick when another tab updates storage
      if (mode === 'player') playerPollTick();
    };
  }
} catch(e) {}

async function storeGet(key) {
  if (USE_SHARED) {
    try { const r = await window.storage.get(key, true); return r ? JSON.parse(r.value) : null; }
    catch { return null; }
  } else {
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : null;
  }
}
async function storeSet(key, val) {
  const s = JSON.stringify(val);
  if (USE_SHARED) {
    try { await window.storage.set(key, s, true); } catch {}
  } else {
    localStorage.setItem(key, s);
    // Notify other tabs immediately via BroadcastChannel
    try { if (_bc) _bc.postMessage({ key }); } catch(e) {}
  }
}
async function storeDel(key) {
  if (USE_SHARED) {
    try { await window.storage.delete(key, true); } catch {}
  } else {
    localStorage.removeItem(key);
    try { if (_bc) _bc.postMessage({ key }); } catch(e) {}
  }
}

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const K = {
  STATE:     'qb:state',       // { phase, qIndex, qStart, qTime, totalQ }
  PLAYERS:   'qb:players',     // { name: { score, totalScore, joined } }
  QUESTIONS: 'qb:questions',   // array of question objects
  ANS:  (i) => `qb:ans:${i}`  // { name: { answer, time } }
};
const SHAPES = ['â–²','â– ','â—','âœ¦'];
const OPT_COLORS = ['ans-a','ans-b','ans-c','ans-d'];
const COLORS_HEX = ['#e8344a','#1a9bfc','#f5a623','#2eb872'];
const AVATAR_COLORS = ['#7c6dfa','#1a9bfc','#f5a623','#2eb872','#e8344a','#ff7eb6','#4fd1f5'];

// â”€â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mode = null;         // 'host' | 'player'
let myName = '';
let questions = [];
let editCorrect = 0;
let editTime = 20;
let pollTimer = null;
let questionTimer = null;
let currentQIndex = 0;
let myAnsweredQIndex = -1;
let myLastScore = 0;
let totalPlayers = 0;

// â”€â”€â”€ Default questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_QUESTIONS = [
  {
    question: "æˆ‘å€‘ç”¢å“ä¸»è¦é‡å°å“ªä¸€é¡å‹çš„å®¢æˆ¶ï¼Ÿ",
    options: ["å€‹äººæ¶ˆè²»è€…", "ä¸­å°ä¼æ¥­", "å¤§å‹é›†åœ˜", "æ”¿åºœæ©Ÿæ§‹"],
    correct: 1, time: 20
  },
  {
    question: "æˆ‘å€‘ç”¢å“æœ€æ ¸å¿ƒçš„ç«¶çˆ­å„ªå‹¢æ˜¯ï¼Ÿ",
    options: ["åƒ¹æ ¼æœ€ä½", "åŠŸèƒ½æœ€å¤š", "æ•´åˆæ€§æœ€é«˜", "å”®å¾Œæœå‹™å¿«"],
    correct: 2, time: 20
  },
  {
    question: "å®¢æˆ¶è©¢å•å ±åƒ¹æ™‚ï¼Œç¬¬ä¸€æ­¥æ‡‰è©²å…ˆåšä»€éº¼ï¼Ÿ",
    options: ["ç›´æ¥å ±æœ€ä½åƒ¹", "äº†è§£å®¢æˆ¶éœ€æ±‚èˆ‡è¦æ¨¡", "ä»‹ç´¹æ‰€æœ‰æ–¹æ¡ˆ", "è½‰äº¤çµ¦ä¸»ç®¡è™•ç†"],
    correct: 1, time: 20
  },
  {
    question: "æˆ‘å€‘çš„æ¨™æº–ç”¢å“å°å…¥é€±æœŸå¤§ç´„æ˜¯å¤šä¹…ï¼Ÿ",
    options: ["1 é€±", "2 - 4 é€±", "2 - 3 å€‹æœˆ", "åŠå¹´ä»¥ä¸Š"],
    correct: 2, time: 20
  },
  {
    question: "é‡åˆ°å®¢æˆ¶åæ˜ ç³»çµ±å•é¡Œï¼Œæ­£ç¢ºè™•ç†é †åºæ˜¯ï¼Ÿ",
    options: ["è«‹å®¢æˆ¶é‡é–‹æ©Ÿ", "ç«‹å³å›å ±æŠ€è¡“éƒ¨ä¸¦è¿½è¹¤", "å‘Šè¨´å®¢æˆ¶é€™æ˜¯å·²çŸ¥å•é¡Œ", "å«å®¢æˆ¶ç­‰æ›´æ–°"],
    correct: 1, time: 20
  },
  {
    question: "ç”¢å“è©¦ç”¨æœŸçµæŸå¾Œçš„è·Ÿé€²ï¼Œæœ€æ™šæ‡‰åœ¨å¹¾å¤©å‰è¯ç¹«ï¼Ÿ",
    options: ["è©¦ç”¨çµæŸç•¶å¤©", "è©¦ç”¨çµæŸå‰ 7 å¤©", "è©¦ç”¨çµæŸå‰ 3 å¤©", "å®¢æˆ¶ä¸»å‹•è¯ç¹«"],
    correct: 1, time: 20
  }
];

// â”€â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function toast(msg) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2800);
}

function avatarColor(name) {
  let h = 0;
  for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) & 0xfffff;
  return AVATAR_COLORS[h % AVATAR_COLORS.length];
}

function initials(name) {
  return name.slice(0, 2).toUpperCase();
}

function launchConfetti() {
  const colors = ['#7c6dfa','#feca57','#ff6b6b','#4fd1f5','#ff9ff3','#2ecc71'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.background = colors[Math.floor(Math.random() * colors.length)];
    el.style.animationDuration = (1.5 + Math.random() * 2) + 's';
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    el.style.transform = `rotate(${Math.random()*180}deg)`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}

function rankLabel(r) {
  if (r === 1) return 'ğŸ¥‡';
  if (r === 2) return 'ğŸ¥ˆ';
  if (r === 3) return 'ğŸ¥‰';
  return `#${r}`;
}

// â”€â”€â”€ QR Code generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildJoinUrl() {
  const loc = window.location;
  // If running from file://, we can't generate a usable QR URL
  if (loc.protocol === 'file:') {
    return null;
  }
  const base = loc.href.split('#')[0].split('?')[0];
  return base + '#join';
}

function genQR(containerId, url) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';

  // Update URL display elements
  const urlTextId = containerId === 'qrcode' ? 'join-url-text' : 'join-url-text2';
  const urlTextEl = document.getElementById(urlTextId);

  if (!url) {
    // Local file mode - QR code not usable
    el.innerHTML = `
      <div style="width:160px;height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f0f0f0;border-radius:8px;padding:12px;box-sizing:border-box">
        <div style="font-size:2rem">ğŸ“</div>
        <div style="font-size:0.62rem;color:#555;text-align:center;margin-top:6px;font-family:sans-serif;line-height:1.4">æœ¬æ©Ÿæª”æ¡ˆæ¨¡å¼<br>QR Code ä¸å¯ç”¨</div>
      </div>`;
    if (urlTextEl) urlTextEl.textContent = 'è«‹å°‡æª”æ¡ˆéƒ¨ç½²è‡³ç¶²é ä¼ºæœå™¨ä»¥å•Ÿç”¨ QR Code åŠŸèƒ½';
    return;
  }

  if (urlTextEl) urlTextEl.textContent = url;

  try {
    if (typeof QRCode === 'undefined') {
      throw new Error('QRCode library not loaded');
    }
    new QRCode(el, {
      text: url,
      width: 160, height: 160,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
  } catch(e) {
    // Fallback: show URL as text with click-to-copy
    el.innerHTML = `
      <div style="width:160px;height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f0f0f0;border-radius:8px;padding:10px;box-sizing:border-box;cursor:pointer" onclick="navigator.clipboard&&navigator.clipboard.writeText('${url.replace(/'/g,"\\'")}').then(()=>toast('âœ… é€£çµå·²è¤‡è£½'))">
        <div style="font-size:1.5rem">ğŸ”—</div>
        <div style="font-size:0.58rem;color:#333;word-break:break-all;text-align:center;margin-top:6px;font-family:sans-serif;line-height:1.3">${url}</div>
        <div style="font-size:0.6rem;color:#888;margin-top:4px;font-family:sans-serif">é»æ“Šè¤‡è£½</div>
      </div>`;
  }
}

// â”€â”€â”€ Question editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildEditorOptions() {
  const grid = document.getElementById('ed-options-grid');
  grid.innerHTML = '';
  const labels = ['A','B','C','D'];
  for (let i = 0; i < 4; i++) {
    const wrap = document.createElement('div');
    wrap.className = 'opt-input-wrap' + (i === editCorrect ? ' correct-opt' : '');
    wrap.id = `opt-wrap-${i}`;
    wrap.onclick = () => setCorrect(i);
    wrap.innerHTML = `
      <span class="opt-badge ${['a','b','c','d'][i]}">${labels[i]}</span>
      <div style="flex:1">
        <input type="text" id="opt-input-${i}" placeholder="é¸é … ${labels[i]}..." onclick="event.stopPropagation()">
        <div class="correct-label">âœ“ æ­£ç¢ºç­”æ¡ˆ</div>
      </div>
    `;
    grid.appendChild(wrap);
  }
  // Time buttons
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.t) === editTime);
    btn.onclick = () => {
      editTime = parseInt(btn.dataset.t);
      document.querySelectorAll('.time-btn').forEach(b => b.classList.toggle('active', b === btn));
    };
  });
}

function setCorrect(i) {
  editCorrect = i;
  for (let j = 0; j < 4; j++) {
    document.getElementById(`opt-wrap-${j}`).classList.toggle('correct-opt', j === i);
  }
}

function resetEditor() {
  document.getElementById('ed-question').value = '';
  for (let i = 0; i < 4; i++) document.getElementById(`opt-input-${i}`).value = '';
  editCorrect = 0;
  editTime = 20;
  buildEditorOptions();
}

function saveCurrentQuestion() {
  const q = document.getElementById('ed-question').value.trim();
  if (!q) return toast('âš ï¸ è«‹è¼¸å…¥å•é¡Œå…§å®¹');
  const opts = [];
  for (let i = 0; i < 4; i++) {
    const v = document.getElementById(`opt-input-${i}`).value.trim();
    if (!v) return toast(`âš ï¸ è«‹å¡«å¯«é¸é … ${['A','B','C','D'][i]}`);
    opts.push(v);
  }
  questions.push({ question: q, options: opts, correct: editCorrect, time: editTime });
  renderQuestionList();
  resetEditor();
  toast('âœ… é¡Œç›®å·²å„²å­˜');
}

function renderQuestionList() {
  const ul = document.getElementById('q-list');
  ul.innerHTML = '';
  questions.forEach((q, i) => {
    const li = document.createElement('li');
    li.className = 'q-item';
    li.innerHTML = `
      <span class="q-num">${i+1}</span>
      <span class="q-text">${q.question.length > 50 ? q.question.slice(0,50)+'â€¦' : q.question}</span>
      <span style="font-size:0.75rem;color:var(--text-muted);margin-right:4px">${q.time}ç§’</span>
      <button class="q-del" onclick="deleteQuestion(event,${i})">âœ•</button>
    `;
    ul.appendChild(li);
  });
}

function deleteQuestion(e, i) {
  e.stopPropagation();
  questions.splice(i, 1);
  renderQuestionList();
}

function loadDefaultQuestions() {
  questions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
  renderQuestionList();
  toast('ğŸ“¦ å·²è¼‰å…¥ ' + questions.length + ' é“ç¯„ä¾‹é¡Œç›®');
}

// â”€â”€â”€ Host Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterHostMode() {
  mode = 'host';
  buildEditorOptions();
  const url = buildJoinUrl();
  genQR('qrcode', url);
  showScreen('screen-host-setup');
}

async function startLobby() {
  if (questions.length === 0) return toast('âš ï¸ è«‹å…ˆæ–°å¢è‡³å°‘ä¸€é“é¡Œç›®');
  // Write questions to shared storage
  await storeSet(K.QUESTIONS, questions);
  await storeSet(K.STATE, { phase: 'lobby', qIndex: 0, qStart: 0, qTime: 0, totalQ: questions.length });
  await storeSet(K.PLAYERS, {});
  // Clear old answers
  for (let i = 0; i < questions.length; i++) await storeDel(K.ANS(i));

  const url = buildJoinUrl();
  genQR('qrcode2', url);
  showScreen('screen-host-lobby');
  startHostLobbyPoll();
}

function startHostLobbyPoll() {
  clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    const players = await storeGet(K.PLAYERS) || {};
    const names = Object.keys(players);
    totalPlayers = names.length;
    document.getElementById('player-count-badge').textContent = names.length + ' äºº';
    const grid = document.getElementById('lobby-players');
    grid.innerHTML = '';
    names.forEach(name => {
      const chip = document.createElement('div');
      chip.className = 'player-chip';
      chip.innerHTML = `<div class="player-avatar" style="background:${avatarColor(name)}">${initials(name)}</div>${name}`;
      grid.appendChild(chip);
    });
  }, 1000);
}

async function startGame() {
  const players = await storeGet(K.PLAYERS) || {};
  if (Object.keys(players).length === 0) return toast('âš ï¸ ç­‰å¾…è‡³å°‘ä¸€ä½ç©å®¶åŠ å…¥');
  clearInterval(pollTimer);
  currentQIndex = 0;
  showHostQuestion();
}

async function showHostQuestion() {
  const q = questions[currentQIndex];
  const state = {
    phase: 'question',
    qIndex: currentQIndex,
    qStart: Date.now(),
    qTime: q.time,
    totalQ: questions.length
  };
  await storeSet(K.STATE, state);
  await storeDel(K.ANS(currentQIndex));

  // Build progress dots
  const prog = document.getElementById('hq-progress');
  prog.innerHTML = '';
  for (let i = 0; i < questions.length; i++) {
    const d = document.createElement('div');
    d.className = 'q-dot' + (i < currentQIndex ? ' done' : i === currentQIndex ? ' active' : '');
    prog.appendChild(d);
  }

  document.getElementById('hq-label').textContent = `ç¬¬ ${currentQIndex+1} / ${questions.length} é¡Œ`;
  document.getElementById('hq-text').textContent = q.question;

  // Build answers
  const wrap = document.getElementById('hq-answers');
  wrap.innerHTML = '';
  q.options.forEach((opt, i) => {
    const div = document.createElement('div');
    div.className = 'ans-btn-host';
    div.dataset.opt = i;
    div.innerHTML = `<div class="ans-shape">${SHAPES[i]}</div><span>${opt}</span>`;
    wrap.appendChild(div);
  });

  // Timer
  const players = await storeGet(K.PLAYERS) || {};
  totalPlayers = Object.keys(players).length;
  document.getElementById('hq-answered-count').textContent = `0 / ${totalPlayers} äººå·²ä½œç­”`;
  document.getElementById('hq-answered-bar').style.width = '0%';

  showScreen('screen-host-question');
  runHostTimer(q.time, state.qStart);
  startAnswerPoll(q.time, state.qStart);
}

function runHostTimer(seconds, startTime) {
  const circle = document.getElementById('host-timer-circle');
  const numEl = document.getElementById('host-timer-num');
  const ring = document.getElementById('host-timer-ring');
  const circumference = 213.6;

  clearInterval(questionTimer);
  questionTimer = setInterval(() => {
    const elapsed = (Date.now() - startTime) / 1000;
    const remaining = Math.max(0, seconds - elapsed);
    const pct = remaining / seconds;

    numEl.textContent = Math.ceil(remaining);
    circle.style.strokeDashoffset = circumference * (1 - pct);
    ring.classList.toggle('urgent', remaining <= 5);

    if (remaining <= 0) {
      clearInterval(questionTimer);
      // Auto end after short delay
      setTimeout(() => endQuestion(), 500);
    }
  }, 100);
}

function startAnswerPoll(seconds, startTime) {
  clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    const answers = await storeGet(K.ANS(currentQIndex)) || {};
    const count = Object.keys(answers).length;
    document.getElementById('hq-answered-count').textContent = `${count} / ${totalPlayers} äººå·²ä½œç­”`;
    const pct = totalPlayers > 0 ? (count / totalPlayers) * 100 : 0;
    document.getElementById('hq-answered-bar').style.width = pct + '%';
  }, 800);
}

async function endQuestion() {
  clearInterval(questionTimer);
  clearInterval(pollTimer);

  const q = questions[currentQIndex];
  const answers = await storeGet(K.ANS(currentQIndex)) || {};
  const qTime = q.time;

  // Calculate scores
  let players = await storeGet(K.PLAYERS) || {};
  const scored = {};

  Object.entries(answers).forEach(([name, data]) => {
    if (!players[name]) players[name] = { score: 0, totalScore: 0, joined: Date.now() };
    const elapsed = Math.max(0, (data.time - (await_lastQStart(currentQIndex))) / 1000);
    let pts = 0;
    if (data.answer === q.correct) {
      const timeFactor = Math.max(0, 1 - (elapsed / qTime) * 0.5);
      pts = Math.round(500 + 500 * timeFactor);
    }
    players[name].score = pts;
    players[name].totalScore = (players[name].totalScore || 0) + pts;
    scored[name] = pts;
  });

  // Players who didn't answer get 0
  Object.keys(players).forEach(name => {
    if (!(name in scored)) {
      players[name].score = 0;
    }
  });

  await storeSet(K.PLAYERS, players);

  const state = { phase: 'results', qIndex: currentQIndex, qStart: 0, qTime: 0, totalQ: questions.length };
  await storeSet(K.STATE, state);

  showHostResults(q, players);
}

// Helper: get question start time (we'll fetch it from state)
let _lastQStart = 0;
function await_lastQStart(qi) { return _lastQStart; }

const _origShowHostQ = showHostQuestion;
showHostQuestion = async function() {
  const q = questions[currentQIndex];
  _lastQStart = Date.now();
  await _origShowHostQ();
};

function showHostResults(q, players) {
  const correctOpt = q.options[q.correct];
  document.getElementById('hr-correct-ans').innerHTML =
    `<div style="font-size:0.8rem;color:rgba(255,255,255,0.8);margin-bottom:4px;font-weight:700;letter-spacing:1px">æ­£ç¢ºç­”æ¡ˆ</div>` +
    `<div style="font-family:'Fredoka One',cursive;font-size:1.4rem">${SHAPES[q.correct]} ${correctOpt}</div>`;

  const sorted = Object.entries(players)
    .map(([name, d]) => ({ name, totalScore: d.totalScore || 0, score: d.score || 0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  const ul = document.getElementById('host-leaderboard');
  ul.innerHTML = '';
  sorted.slice(0, 8).forEach((p, i) => {
    const li = document.createElement('li');
    li.className = 'lb-item';
    li.style.animationDelay = (i * 0.08) + 's';
    li.innerHTML = `
      <div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}</div>
      <div class="lb-score">${p.totalScore.toLocaleString()}</div>
      ${p.score > 0 ? `<div class="lb-delta">+${p.score}</div>` : ''}
    `;
    ul.appendChild(li);
  });

  const isLast = currentQIndex >= questions.length - 1;
  const btn = document.getElementById('btn-next-q');
  btn.textContent = isLast ? 'ğŸ† æŸ¥çœ‹æœ€çµ‚çµæœ' : 'ä¸‹ä¸€é¡Œ â†’';
  showScreen('screen-host-results');
}

async function nextQuestion() {
  if (currentQIndex >= questions.length - 1) {
    showFinalResults();
    return;
  }
  currentQIndex++;
  showHostQuestion();
}

async function showFinalResults() {
  const players = await storeGet(K.PLAYERS) || {};
  const state = { phase: 'final', qIndex: currentQIndex, qStart: 0, qTime: 0, totalQ: questions.length };
  await storeSet(K.STATE, state);

  const sorted = Object.entries(players)
    .map(([name, d]) => ({ name, totalScore: d.totalScore || 0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  // Podium
  const podium = document.getElementById('final-podium');
  podium.innerHTML = '';
  const podiumOrder = [1, 0, 2]; // 2nd, 1st, 3rd placement
  const podiumClass = ['second','first','third'];
  podiumOrder.forEach((rank, pi) => {
    const p = sorted[rank];
    if (!p) return;
    const div = document.createElement('div');
    div.className = 'podium-item';
    div.innerHTML = `
      <div class="podium-name">${p.name}</div>
      <div class="podium-score">${p.totalScore.toLocaleString()}</div>
      <div class="podium-base ${podiumClass[pi]}">${rankLabel(rank+1)}</div>
    `;
    podium.appendChild(div);
  });

  const ul = document.getElementById('host-final-leaderboard');
  ul.innerHTML = '';
  sorted.forEach((p, i) => {
    const li = document.createElement('li');
    li.className = 'lb-item';
    li.style.animationDelay = (i * 0.07) + 's';
    li.innerHTML = `
      <div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}</div>
      <div class="lb-score">${p.totalScore.toLocaleString()}</div>
    `;
    ul.appendChild(li);
  });
  showScreen('screen-host-final');
  launchConfetti();
}

async function restartGame() {
  await storeDel(K.STATE);
  await storeDel(K.PLAYERS);
  for (let i = 0; i < questions.length; i++) await storeDel(K.ANS(i));
  questions = [];
  renderQuestionList();
  resetEditor();
  showScreen('screen-host-setup');
}

// â”€â”€â”€ Player Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function joinGame() {
  const name = document.getElementById('player-name-input').value.trim();
  if (!name) return toast('âš ï¸ è«‹è¼¸å…¥ä½ çš„å§“å');

  // Check if game is active
  const state = await storeGet(K.STATE);
  if (!state) return toast('âš ï¸ å°šæœªæœ‰ä¸»æŒäººé–‹å•ŸéŠæˆ²ï¼Œè«‹ç¨å¾Œå†è©¦');
  if (state.phase === 'final') return toast('âš ï¸ éŠæˆ²å·²çµæŸ');

  myName = name;
  mode = 'player';
  myAnsweredQIndex = -1;
  currentQIndex = state.qIndex;

  // Register player
  let players = await storeGet(K.PLAYERS) || {};
  if (players[name]) {
    // Rejoin
    toast('ğŸ‘‹ æ­¡è¿å›ä¾†ï¼Œ' + name + 'ï¼');
  } else {
    players[name] = { score: 0, totalScore: 0, joined: Date.now() };
    await storeSet(K.PLAYERS, players);
    toast('âœ… æˆåŠŸåŠ å…¥ï¼');
  }

  document.getElementById('plobby-name-badge').textContent = 'ğŸ‘¤ ' + name;
  showScreen('screen-player-lobby');
  startPlayerPoll();
}

function startPlayerPoll() {
  clearInterval(pollTimer);
  pollTimer = setInterval(playerPollTick, 800);
}

async function playerPollTick() {
  const state = await storeGet(K.STATE);
  if (!state) return;

  if (state.phase === 'lobby') {
    showScreen('screen-player-lobby');
    return;
  }

  if (state.phase === 'question') {
    currentQIndex = state.qIndex;
    if (myAnsweredQIndex === state.qIndex) {
      // Already answered this question - show waiting
      if (!document.getElementById('screen-player-feedback').classList.contains('active')) {
        showPlayerFeedback(state.qIndex);
      }
      return;
    }
    // Show question screen
    if (!document.getElementById('screen-player-question').classList.contains('active')) {
      const qs = await storeGet(K.QUESTIONS);
      if (qs) {
        questions = qs;
        showPlayerQuestion(state);
      }
    } else {
      // Update timer
      updatePlayerTimer(state);
    }
    return;
  }

  if (state.phase === 'results') {
    currentQIndex = state.qIndex;
    showPlayerResults(state.qIndex);
    return;
  }

  if (state.phase === 'final') {
    showPlayerFinal();
    return;
  }
}

let playerTimerInterval = null;
let lastShownQIndex = -99;

async function showPlayerQuestion(state) {
  if (lastShownQIndex === state.qIndex) return;
  lastShownQIndex = state.qIndex;

  const q = questions[state.qIndex];
  document.getElementById('pq-label').textContent = `ç¬¬ ${state.qIndex+1} / ${state.totalQ} é¡Œ`;
  document.getElementById('pq-text').textContent = q.question;

  const wrap = document.getElementById('pq-answers');
  wrap.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'ans-btn-player';
    btn.dataset.opt = i;
    btn.innerHTML = `<span class="shape-icon">${SHAPES[i]}</span><span>${opt}</span>`;
    btn.onclick = () => playerAnswer(i, state);
    wrap.appendChild(btn);
  });

  showScreen('screen-player-question');
  runPlayerTimer(state);
}

function runPlayerTimer(state) {
  const circle = document.getElementById('player-timer-circle');
  const numEl = document.getElementById('player-timer-num');
  const ring = document.getElementById('player-timer-ring');
  const circumference = 213.6;
  const seconds = state.qTime;
  const startTime = state.qStart;

  clearInterval(playerTimerInterval);
  playerTimerInterval = setInterval(() => {
    const elapsed = (Date.now() - startTime) / 1000;
    const remaining = Math.max(0, seconds - elapsed);
    const pct = remaining / seconds;
    numEl.textContent = Math.ceil(remaining);
    circle.style.strokeDashoffset = circumference * (1 - pct);
    ring.classList.toggle('urgent', remaining <= 5);
    if (remaining <= 0) {
      clearInterval(playerTimerInterval);
      // Disable all answers
      document.querySelectorAll('.ans-btn-player').forEach(b => b.classList.add('disabled'));
    }
  }, 100);
}

function updatePlayerTimer(state) {
  // handled by interval above
}

async function playerAnswer(optIndex, state) {
  if (myAnsweredQIndex === state.qIndex) return;
  myAnsweredQIndex = state.qIndex;
  clearInterval(playerTimerInterval);

  // Disable buttons
  document.querySelectorAll('.ans-btn-player').forEach((b, i) => {
    b.classList.add('disabled');
    if (i === optIndex) b.classList.add('selected');
  });

  // Store answer
  let answers = await storeGet(K.ANS(state.qIndex)) || {};
  answers[myName] = { answer: optIndex, time: Date.now() };
  await storeSet(K.ANS(state.qIndex), answers);

  // Calculate provisional score
  const q = questions[state.qIndex];
  const elapsed = (Date.now() - state.qStart) / 1000;
  let pts = 0;
  const isCorrect = optIndex === q.correct;
  if (isCorrect) {
    const timeFactor = Math.max(0, 1 - (elapsed / state.qTime) * 0.5);
    pts = Math.round(500 + 500 * timeFactor);
  }
  myLastScore = pts;

  // Show feedback
  showPlayerFeedback(state.qIndex, isCorrect, pts);
}

async function showPlayerFeedback(qIndex, isCorrect, pts) {
  if (isCorrect !== undefined) {
    // Fresh feedback
    document.getElementById('pf-icon').textContent = isCorrect ? 'ğŸ‰' : 'ğŸ˜¢';
    document.getElementById('pf-text').textContent = isCorrect ? 'ç­”å°äº†ï¼' : 'ç­”éŒ¯äº†...';
    document.getElementById('pf-points').textContent = `+${pts || 0}`;

    if (isCorrect) launchConfetti();

    // Rank
    const players = await storeGet(K.PLAYERS) || {};
    const sorted = Object.entries(players)
      .map(([n, d]) => ({ n, s: d.totalScore || 0 }))
      .sort((a, b) => b.s - a.s);
    const rank = sorted.findIndex(p => p.n === myName) + 1;
    document.getElementById('pf-rank').textContent = rank > 0 ? `ç›®å‰æ’åï¼šç¬¬ ${rank} å` : 'è¨ˆç®—æ’åä¸­...';
  }
  if (!document.getElementById('screen-player-feedback').classList.contains('active')) {
    showScreen('screen-player-feedback');
  }
}

let lastResultsQIndex = -99;

async function showPlayerResults(qIndex) {
  if (lastResultsQIndex === qIndex) return;
  lastResultsQIndex = qIndex;

  const q = questions[qIndex];
  const players = await storeGet(K.PLAYERS) || {};
  const answers = await storeGet(K.ANS(qIndex)) || {};
  const myAns = answers[myName];
  const isCorrect = myAns && myAns.answer === q.correct;

  document.getElementById('pr-q-result').textContent = `ç¬¬ ${qIndex+1} é¡Œçµæœ`;

  const banner = document.getElementById('pr-feedback-banner');
  if (!myAns) {
    banner.style.background = 'rgba(255,255,255,0.08)';
    banner.innerHTML = `<div style="font-size:1.3rem">âŒ›</div><div>æœªä½œç­”</div>`;
  } else if (isCorrect) {
    banner.style.background = 'linear-gradient(135deg,#2eb872,#22965b)';
    banner.innerHTML = `<div style="font-size:1.3rem">âœ…</div><div style="font-family:'Fredoka One',cursive">ç­”å°äº†ï¼ +${myLastScore}</div>`;
  } else {
    banner.style.background = 'linear-gradient(135deg,#e8344a,#c02336)';
    banner.innerHTML = `<div style="font-size:1.3rem">âŒ</div><div style="font-family:'Fredoka One',cursive">ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆï¼š${q.options[q.correct]}</div>`;
  }

  const sorted = Object.entries(players)
    .map(([name, d]) => ({ name, totalScore: d.totalScore || 0, score: d.score || 0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  const ul = document.getElementById('player-leaderboard');
  ul.innerHTML = '';
  sorted.slice(0, 6).forEach((p, i) => {
    const isMe = p.name === myName;
    const li = document.createElement('li');
    li.className = 'lb-item';
    li.style.animationDelay = (i * 0.08) + 's';
    if (isMe) li.style.border = '2px solid var(--primary)';
    li.innerHTML = `
      <div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}${isMe ? ' <span style="font-size:0.7rem;color:var(--primary)">(æˆ‘)</span>' : ''}</div>
      <div class="lb-score">${p.totalScore.toLocaleString()}</div>
      ${p.score > 0 ? `<div class="lb-delta">+${p.score}</div>` : ''}
    `;
    ul.appendChild(li);
  });
  showScreen('screen-player-results');
}

let shownFinal = false;
async function showPlayerFinal() {
  if (shownFinal) return;
  shownFinal = true;
  clearInterval(pollTimer);

  const players = await storeGet(K.PLAYERS) || {};
  const sorted = Object.entries(players)
    .map(([name, d]) => ({ name, totalScore: d.totalScore || 0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  const myRank = sorted.findIndex(p => p.n === myName) + 1 || sorted.findIndex(p => p.name === myName) + 1;
  const myData = players[myName] || { totalScore: 0 };

  const rankIcons = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('pfinal-rank-icon').textContent = myRank <= 3 ? rankIcons[myRank-1] : 'ğŸ‰';
  document.getElementById('pfinal-score').textContent = (myData.totalScore || 0).toLocaleString();
  document.getElementById('pfinal-rank').textContent = `æœ€çµ‚æ’åï¼šç¬¬ ${myRank} å`;
  document.getElementById('pfinal-msg').textContent =
    myRank === 1 ? 'æ­å–œå¥ªå¾—ç¬¬ä¸€åï¼ğŸ†' : myRank <= 3 ? 'è¡¨ç¾å„ªç•°ï¼' : 'æ„Ÿè¬åƒèˆ‡ï¼ç¹¼çºŒåŠ æ²¹ï¼';
  document.getElementById('pfinal-sub').textContent =
    `${myName} Â· éŠæˆ²çµæŸ`;

  const ul = document.getElementById('player-final-leaderboard');
  ul.innerHTML = '';
  sorted.forEach((p, i) => {
    const isMe = p.name === myName;
    const li = document.createElement('li');
    li.className = 'lb-item';
    li.style.animationDelay = (i * 0.07) + 's';
    if (isMe) li.style.border = '2px solid var(--primary)';
    li.innerHTML = `
      <div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}${isMe ? ' <span style="font-size:0.7rem;color:var(--primary)">(æˆ‘)</span>' : ''}</div>
      <div class="lb-score">${p.totalScore.toLocaleString()}</div>
    `;
    ul.appendChild(li);
  });

  showScreen('screen-player-final');
  if (myRank <= 3) launchConfetti();
}

// â”€â”€â”€ URL hash detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const hash = window.location.hash;
  if (hash === '#join') {
    // Auto-navigate to player join
    showScreen('screen-player-join');
    // Remove hash from URL without page reload
    history.replaceState(null, '', window.location.pathname + window.location.search);
  }

  // Show local-file notice on home screen if applicable
  if (window.location.protocol === 'file:') {
    const notice = document.createElement('p');
    notice.style.cssText = 'color:rgba(255,200,80,0.85);font-size:0.75rem;text-align:center;margin-top:12px;font-weight:700;max-width:400px';
    notice.textContent = 'âš ï¸ æœ¬æ©Ÿæ¨¡å¼ï¼šè«‹åœ¨åŒä¸€ç€è¦½å™¨é–‹å•Ÿå…©å€‹åˆ†é é€²è¡Œæ¸¬è©¦ï¼ˆQR Code ä¸é©ç”¨ï¼‰';
    const homeScreen = document.getElementById('screen-home');
    homeScreen.appendChild(notice);
  }
}

init();
</script>
</body>
</html>
