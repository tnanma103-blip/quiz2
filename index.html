<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Q1 POA âš¡ Livalo & Livazebe æ•™è‚²è¨“ç·´</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d1a; --surface: #161628; --surface2: #1e1e38;
  --border: rgba(255,255,255,0.08); --primary: #7c6dfa;
  --primary-glow: rgba(124,109,250,0.35);
  --ans-a: #e8344a; --ans-b: #1a9bfc; --ans-c: #f5a623; --ans-d: #2eb872;
  --ans-a-dark: #c02336; --ans-b-dark: #0f7ed4; --ans-c-dark: #d4891a; --ans-d-dark: #22965b;
  --yellow: #ffe066; --cyan: #4fd1f5; --pink: #ff7eb6;
  --text: #ffffff; --text-muted: rgba(255,255,255,0.55);
  --radius: 16px; --radius-sm: 10px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; }
body { background: var(--bg); color: var(--text); font-family: 'Nunito', sans-serif; min-height: 100vh; overflow-x: hidden; }
body::before {
  content: ''; position: fixed; inset: 0;
  background-image:
    radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.18) 0%, transparent 100%),
    radial-gradient(1px 1px at 60% 70%, rgba(255,255,255,0.12) 0%, transparent 100%),
    radial-gradient(1px 1px at 80% 15%, rgba(255,255,255,0.15) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 45% 55%, rgba(200,180,255,0.2) 0%, transparent 100%);
  pointer-events: none; z-index: 0;
}
body::after {
  content: ''; position: fixed; bottom: -200px; left: -200px; width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(124,109,250,0.12) 0%, transparent 70%);
  pointer-events: none; z-index: 0; animation: floatGlow 8s ease-in-out infinite alternate;
}
@keyframes floatGlow { from { transform: translate(0,0); } to { transform: translate(60px,-40px); } }

.screen { position: relative; z-index: 1; min-height: 100vh; display: none; flex-direction: column; align-items: center; padding: 20px; }
.screen.active { display: flex; }

.logo {
  font-family: 'Fredoka One', cursive; font-size: clamp(2.2rem, 6vw, 3.5rem);
  background: linear-gradient(135deg, var(--cyan) 0%, var(--primary) 50%, var(--pink) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  filter: drop-shadow(0 0 20px rgba(124,109,250,0.5)); margin-bottom: 4px;
}
.logo-sub { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 32px; }

.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; width: 100%; max-width: 560px; margin-bottom: 16px; position: relative; overflow: hidden; }
.card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--primary), var(--cyan)); opacity: 0.7; }

.btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border: none; border-radius: var(--radius-sm); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
.btn::after { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.15); opacity: 0; transition: opacity 0.2s; }
.btn:hover::after { opacity: 1; }
.btn:active { transform: scale(0.97); }
.btn-primary { background: linear-gradient(135deg, var(--primary), #9b6dfa); color: white; box-shadow: 0 4px 20px rgba(124,109,250,0.4); }
.btn-primary:hover { box-shadow: 0 6px 28px rgba(124,109,250,0.6); transform: translateY(-1px); }
.btn-secondary { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
.btn-secondary:hover { border-color: var(--primary); }
.btn-lg { padding: 18px 40px; font-size: 1.15rem; border-radius: 14px; }
.btn-full { width: 100%; }

.input-field { background: var(--surface2); border: 2px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 700; padding: 12px 16px; width: 100%; transition: border-color 0.2s; outline: none; }
.input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
.input-field::placeholder { color: var(--text-muted); font-weight: 600; }
label { display: block; font-size: 0.8rem; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }

#screen-home { justify-content: center; text-align: center; }
.mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%; max-width: 560px; margin-top: 8px; }
.mode-card { background: var(--surface); border: 2px solid var(--border); border-radius: var(--radius); padding: 32px 20px; cursor: pointer; transition: all 0.25s ease; text-align: center; }
.mode-card:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 12px 40px rgba(124,109,250,0.3); }
.mode-card .icon { font-size: 3rem; margin-bottom: 12px; display: block; }
.mode-card h3 { font-family: 'Fredoka One', cursive; font-size: 1.3rem; margin-bottom: 6px; }
.mode-card p { font-size: 0.82rem; color: var(--text-muted); font-weight: 600; }

.room-code-display { background: var(--surface2); border: 2px solid var(--primary); border-radius: var(--radius); padding: 20px; text-align: center; margin: 16px 0; }
.room-code-display .code { font-family: 'Fredoka One', cursive; font-size: 3.5rem; letter-spacing: 12px; color: var(--yellow); filter: drop-shadow(0 0 16px rgba(255,224,102,0.5)); }
.room-code-display .code-label { font-size: 0.75rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }

.question-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
.q-item { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px 16px; display: flex; align-items: center; gap: 12px; }
.q-item .q-num { background: var(--primary); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 900; flex-shrink: 0; }
.q-item .q-text { flex: 1; font-size: 0.9rem; font-weight: 700; }
.q-item .q-del { color: var(--ans-a); cursor: pointer; padding: 4px; opacity: 0.6; transition: opacity 0.2s; background: none; border: none; font-size: 1.1rem; }
.q-item .q-del:hover { opacity: 1; }

.q-editor { background: var(--surface2); border: 1px solid var(--primary); border-radius: var(--radius); padding: 20px; margin-top: 8px; }
.options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.opt-input-wrap { display: flex; align-items: center; gap: 8px; background: var(--surface); border: 2px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; cursor: pointer; transition: border-color 0.2s; }
.opt-input-wrap.correct-opt { border-color: var(--ans-d); }
.opt-input-wrap input[type="text"] { background: none; border: none; outline: none; color: var(--text); font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.9rem; flex: 1; }
.opt-badge { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 900; color: white; flex-shrink: 0; }
.opt-badge.a { background: var(--ans-a); } .opt-badge.b { background: var(--ans-b); } .opt-badge.c { background: var(--ans-c); } .opt-badge.d { background: var(--ans-d); }
.correct-label { font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; color: var(--ans-d); margin-top: 6px; display: none; }
.opt-input-wrap.correct-opt .correct-label { display: block; }
.time-select { display: flex; gap: 8px; flex-wrap: wrap; }
.time-btn { padding: 8px 14px; border-radius: 8px; border: 2px solid var(--border); background: var(--surface); color: var(--text); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
.time-btn.active { border-color: var(--cyan); background: rgba(79,209,245,0.15); color: var(--cyan); }

.qr-area { background: white; border-radius: 14px; padding: 14px; display: inline-block; margin: 12px auto; }
#qrcode canvas, #qrcode img, #qrcode2 canvas, #qrcode2 img { display: block; }
.join-url { font-size: 0.75rem; color: var(--text-muted); word-break: break-all; margin-top: 8px; text-align: center; }

.players-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.player-chip { background: var(--surface2); border: 2px solid var(--border); border-radius: 50px; padding: 8px 18px; font-weight: 800; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; animation: popIn 0.3s ease; }
@keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.player-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 900; color: white; }

.timer-wrap { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
.timer-ring { position: relative; width: 80px; height: 80px; }
.timer-ring svg { transform: rotate(-90deg); }
.timer-ring circle { fill: none; stroke-width: 6; stroke-linecap: round; stroke-dasharray: 213.6; }
.timer-bg { stroke: var(--surface2); }
.timer-prog { stroke: var(--cyan); transition: stroke-dashoffset 0.1s linear; stroke-dashoffset: 0; }
.timer-num { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: var(--cyan); }
.timer-ring.urgent .timer-prog { stroke: var(--ans-a); }
.timer-ring.urgent .timer-num { color: var(--ans-a); animation: shake 0.3s ease infinite; }

.q-progress { display: flex; gap: 6px; margin-bottom: 20px; }
.q-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--border); transition: background 0.3s; }
.q-dot.done { background: var(--primary); } .q-dot.active { background: var(--yellow); }
.question-box { background: var(--surface2); border-radius: var(--radius); padding: 28px; text-align: center; font-family: 'Fredoka One', cursive; font-size: clamp(1.2rem, 3vw, 1.7rem); line-height: 1.4; margin-bottom: 20px; border: 1px solid var(--border); width: 100%; }
.answered-bar-wrap { background: var(--surface2); border-radius: 50px; height: 8px; width: 100%; overflow: hidden; margin: 8px 0; }
.answered-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--cyan)); border-radius: 50px; transition: width 0.5s ease; }
.answered-count { font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-align: center; }

.answers-host { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
.ans-btn-host { border-radius: 14px; padding: 18px 14px; font-family: 'Fredoka One', cursive; font-size: 1.05rem; color: white; display: flex; align-items: center; gap: 10px; border: none; }
.ans-btn-host[data-opt="0"] { background: linear-gradient(135deg, var(--ans-a), var(--ans-a-dark)); }
.ans-btn-host[data-opt="1"] { background: linear-gradient(135deg, var(--ans-b), var(--ans-b-dark)); }
.ans-btn-host[data-opt="2"] { background: linear-gradient(135deg, var(--ans-c), var(--ans-c-dark)); }
.ans-btn-host[data-opt="3"] { background: linear-gradient(135deg, var(--ans-d), var(--ans-d-dark)); }
.ans-shape { width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1rem; }

.answers-player { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; width: 100%; }
.ans-btn-player { border-radius: 16px; padding: 24px 14px; font-family: 'Fredoka One', cursive; font-size: 1.05rem; color: white; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: all 0.15s ease; position: relative; overflow: hidden; }
.ans-btn-player:active { transform: scale(0.95); }
.ans-btn-player[data-opt="0"] { background: linear-gradient(135deg, var(--ans-a), var(--ans-a-dark)); box-shadow: 0 6px 20px rgba(232,52,74,0.4); }
.ans-btn-player[data-opt="1"] { background: linear-gradient(135deg, var(--ans-b), var(--ans-b-dark)); box-shadow: 0 6px 20px rgba(26,155,252,0.4); }
.ans-btn-player[data-opt="2"] { background: linear-gradient(135deg, var(--ans-c), var(--ans-c-dark)); box-shadow: 0 6px 20px rgba(245,166,35,0.4); }
.ans-btn-player[data-opt="3"] { background: linear-gradient(135deg, var(--ans-d), var(--ans-d-dark)); box-shadow: 0 6px 20px rgba(46,184,114,0.4); }
.ans-btn-player .shape-icon { font-size: 2rem; }
.ans-btn-player.disabled { opacity: 0.35; pointer-events: none; }
.ans-btn-player.selected { transform: scale(1.04); }
.ans-btn-player.selected::after { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.25); }

.leaderboard { list-style: none; display: flex; flex-direction: column; gap: 10px; width: 100%; }
.lb-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px 18px; display: flex; align-items: center; gap: 14px; animation: slideIn 0.4s ease both; }
@keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
.lb-rank { font-family: 'Fredoka One', cursive; font-size: 1.3rem; width: 36px; text-align: center; flex-shrink: 0; }
.lb-rank.top-1 { color: var(--yellow); } .lb-rank.top-2 { color: #c0c0c0; } .lb-rank.top-3 { color: #cd7f32; }
.lb-name { flex: 1; font-weight: 800; font-size: 0.95rem; }
.lb-score { font-family: 'Fredoka One', cursive; font-size: 1.2rem; color: var(--cyan); }
.lb-delta { font-size: 0.75rem; font-weight: 800; color: var(--ans-d); background: rgba(46,184,114,0.15); padding: 3px 8px; border-radius: 20px; }

.feedback-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; width: 100%; text-align: center; }
.feedback-icon { font-size: 5rem; margin-bottom: 12px; animation: bounceIn 0.5s ease; }
@keyframes bounceIn { 0% { transform: scale(0); } 60% { transform: scale(1.2); } 100% { transform: scale(1); } }
.points-earned { font-family: 'Fredoka One', cursive; font-size: 3.5rem; color: var(--yellow); }
.player-rank-badge { background: var(--surface2); border: 2px solid var(--primary); border-radius: 50px; padding: 10px 24px; font-family: 'Fredoka One', cursive; font-size: 1.2rem; margin-top: 10px; color: var(--cyan); }
.correct-banner { background: linear-gradient(135deg, var(--ans-d), var(--ans-d-dark)); border-radius: var(--radius); padding: 20px 28px; text-align: center; margin-bottom: 20px; width: 100%; }

.podium { display: flex; align-items: flex-end; justify-content: center; gap: 12px; margin: 20px 0; }
.podium-item { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100px; }
.podium-base { width: 100%; border-radius: 8px 8px 0 0; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; font-family: 'Fredoka One', cursive; font-size: 1.8rem; }
.podium-base.first  { height: 120px; background: linear-gradient(180deg, rgba(255,224,102,0.3), rgba(255,224,102,0.15)); border: 1px solid rgba(255,224,102,0.4); }
.podium-base.second { height: 90px;  background: linear-gradient(180deg, rgba(192,192,192,0.3), rgba(192,192,192,0.15)); border: 1px solid rgba(192,192,192,0.4); }
.podium-base.third  { height: 70px;  background: linear-gradient(180deg, rgba(205,127,50,0.3),  rgba(205,127,50,0.15));  border: 1px solid rgba(205,127,50,0.4); }
.podium-name { font-weight: 900; font-size: 0.85rem; text-align: center; max-width: 100px; word-break: break-word; }
.podium-score { font-family: 'Fredoka One', cursive; font-size: 1rem; color: var(--cyan); }

.text-center { text-align: center; }
.section-title { font-family: 'Fredoka One', cursive; font-size: 1.4rem; margin-bottom: 16px; }
.section-subtitle { color: var(--text-muted); font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; }
.row { display: flex; gap: 10px; } .flex-1 { flex: 1; }
.mt-8 { margin-top: 8px; } .mt-16 { margin-top: 16px; } .mt-24 { margin-top: 24px; }
.separator { border: none; border-top: 1px solid var(--border); margin: 18px 0; }
.badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 800; letter-spacing: 0.5px; }
.badge-primary { background: rgba(124,109,250,0.2); color: var(--primary); border: 1px solid rgba(124,109,250,0.4); }
.badge-success { background: rgba(46,184,114,0.2); color: var(--ans-d); border: 1px solid rgba(46,184,114,0.4); }
.badge-warn { background: rgba(245,166,35,0.2); color: var(--ans-c); border: 1px solid rgba(245,166,35,0.4); }

.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: var(--surface2); border: 1px solid var(--primary); border-radius: 50px; padding: 10px 24px; font-weight: 700; font-size: 0.9rem; z-index: 999; animation: toastIn 0.3s ease; box-shadow: 0 8px 30px rgba(0,0,0,0.5); white-space: nowrap; }
@keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
@keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-3deg); } 75% { transform: rotate(3deg); } }
.waiting-anim { display: flex; gap: 6px; justify-content: center; margin: 20px 0; }
.waiting-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--primary); animation: waitDot 1.2s ease-in-out infinite; }
.waiting-dot:nth-child(2) { animation-delay: 0.2s; } .waiting-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes waitDot { 0%, 100% { opacity: 0.2; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-8px); } }
.confetti-piece { position: fixed; width: 10px; height: 12px; border-radius: 2px; top: -20px; animation: confettiFall linear forwards; z-index: 999; pointer-events: none; }
@keyframes confettiFall { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

/* Token setup panel */
.token-panel { background: rgba(124,109,250,0.08); border: 1px solid rgba(124,109,250,0.3); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 16px; }
.token-panel .token-row { display: flex; gap: 8px; align-items: center; }
.token-panel input { flex: 1; background: var(--surface2); border: 2px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: monospace; font-size: 0.85rem; padding: 10px 12px; outline: none; }
.token-panel input:focus { border-color: var(--primary); }
.sync-status { display: inline-flex; align-items: center; gap: 6px; font-size: 0.78rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; }
.sync-status.ok   { background: rgba(46,184,114,0.2); color: var(--ans-d); }
.sync-status.err  { background: rgba(232,52,74,0.2);  color: var(--ans-a); }
.sync-status.idle { background: rgba(255,255,255,0.08); color: var(--text-muted); }

.room-input-group { display: flex; gap: 10px; align-items: stretch; }
.room-input-group .input-field { font-size: 1.5rem; letter-spacing: 8px; text-align: center; text-transform: uppercase; }
</style>
</head>
<body>

<!-- â•â• HOME â•â• -->
<section class="screen active" id="screen-home">
  <div style="text-align:center;margin-bottom:32px;margin-top:10vh">
    <div class="logo">âš¡ Q1 POA</div>
    <div class="logo-sub">Livalo &amp; Livazebe æ•™è‚²è¨“ç·´</div>
  </div>
  <div class="mode-grid">
    <div class="mode-card" onclick="enterHostMode()">
      <span class="icon">ğŸ®</span><h3>ä¸»æŒéŠæˆ²</h3><p>å»ºç«‹é¡Œç›®<br>ç®¡ç†éŠæˆ²æµç¨‹</p>
    </div>
    <div class="mode-card" onclick="showScreen('screen-player-join')">
      <span class="icon">ğŸ™‹</span><h3>åŠ å…¥éŠæˆ²</h3><p>è¼¸å…¥æˆ¿é–“ç¢¼<br>é–‹å§‹ç«¶è³½ç­”é¡Œ</p>
    </div>
  </div>
</section>

<!-- â•â• HOST SETUP â•â• -->
<section class="screen" id="screen-host-setup">
  <div style="text-align:center;margin-bottom:24px;padding-top:20px">
    <div class="logo" style="font-size:2rem">âš¡ Q1 POA</div>
    <span class="badge badge-primary" style="margin-top:6px">ä¸»æŒäººæ¨¡å¼</span>
  </div>

  <!-- GitHub Token è¨­å®š -->
  <div class="card" style="max-width:760px">
    <div class="section-title">ğŸ”‘ GitHub Token è¨­å®š</div>
    <p style="font-size:0.82rem;color:var(--text-muted);font-weight:700;margin-bottom:12px">
      Token åªå­˜åœ¨è¨˜æ†¶é«”ï¼Œé—œé–‰é é¢å³æ¶ˆå¤±ã€‚éœ€è¦ <code style="background:var(--surface2);padding:2px 6px;border-radius:4px">gist</code> æ¬Šé™ã€‚
    </p>
    <div class="token-panel">
      <div class="token-row">
        <input type="password" id="github-token-input" placeholder="è²¼ä¸Šä½ çš„ GitHub Tokenï¼ˆghp_...ï¼‰">
        <button class="btn btn-primary" onclick="applyToken()">å¥—ç”¨</button>
      </div>
      <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
        <span class="sync-status idle" id="token-status">â¬¤ å°šæœªè¨­å®š</span>
        <a href="https://github.com/settings/tokens/new?scopes=gist&description=QuizGame" target="_blank"
           style="font-size:0.78rem;color:var(--primary);font-weight:700;text-decoration:none">
          â†’ ç”³è«‹æ–° Token
        </a>
      </div>
    </div>
  </div>

  <!-- é¡Œç›®ç®¡ç† -->
  <div class="card" style="max-width:760px">
    <div class="section-title">ğŸ“‹ é¡Œç›®ç®¡ç†</div>
    <ul class="question-list" id="q-list"></ul>
    <div class="q-editor mt-16">
      <div class="section-subtitle">â• æ–°å¢ / ç·¨è¼¯é¡Œç›®</div>
      <label>å•é¡Œ</label>
      <input class="input-field" id="ed-question" type="text" placeholder="è¼¸å…¥å•é¡Œå…§å®¹...">
      <div class="options-grid mt-8" id="ed-options-grid"></div>
      <p style="font-size:0.78rem;color:var(--text-muted);margin-top:8px">ğŸ’¡ é»æ“Šé¸é …åˆ—å³å¯è¨­ç‚ºæ­£ç¢ºç­”æ¡ˆ</p>
      <div style="margin-top:14px">
        <label>ä½œç­”æ™‚é–“</label>
        <div class="time-select" id="ed-time-btns">
          <button class="time-btn" data-t="10">10ç§’</button>
          <button class="time-btn active" data-t="20">20ç§’</button>
          <button class="time-btn" data-t="30">30ç§’</button>
          <button class="time-btn" data-t="60">60ç§’</button>
        </div>
      </div>
      <div class="row mt-16">
        <button class="btn btn-primary flex-1" onclick="saveCurrentQuestion()">ğŸ’¾ å„²å­˜é¡Œç›®</button>
        <button class="btn btn-secondary" onclick="resetEditor()">ğŸ”„ æ¸…é™¤</button>
      </div>
    </div>
    <hr class="separator">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <button class="btn btn-secondary" onclick="loadDefaultQuestions()">ğŸ“¦ è¼‰å…¥ç¯„ä¾‹é¡Œç›®</button>
      <span style="color:var(--text-muted);font-size:0.8rem">Livalo &amp; Livazebe ç›¸é—œé¡Œç›®</span>
    </div>
  </div>

  <div class="card" style="max-width:760px">
    <button class="btn btn-primary btn-full btn-lg" onclick="startLobby()">ğŸš€ é–‹æ”¾åŠ å…¥ç­‰å¾…å®¤</button>
  </div>
  <button class="btn btn-secondary mt-8" onclick="showScreen('screen-home')">â† è¿”å›</button>
</section>

<!-- â•â• HOST LOBBY â•â• -->
<section class="screen" id="screen-host-lobby">
  <div style="text-align:center;padding-top:24px;margin-bottom:20px">
    <div class="logo" style="font-size:2rem">âš¡ Q1 POA</div>
    <div class="logo-sub">ç­‰å¾…å®¤é–‹æ”¾ä¸­</div>
  </div>
  <div class="card" style="max-width:700px;text-align:center">
    <div class="section-title">ğŸ”‘ æˆ¿é–“ç¢¼</div>
    <div class="room-code-display">
      <div class="code-label">è«‹ç©å®¶è¼¸å…¥æ­¤ç¢¼åŠ å…¥</div>
      <div class="code" id="host-room-code">----</div>
    </div>
    <div class="qr-area" style="margin:0 auto 12px"><div id="qrcode2"></div></div>
    <p class="join-url" id="join-url-text2">â€”</p>
    <p style="font-size:0.82rem;color:var(--text-muted);margin-top:8px">æƒæ QR Code æˆ–è¼¸å…¥æˆ¿é–“ç¢¼åŠ å…¥</p>
    <div style="margin-top:10px">
      <span class="sync-status ok" id="lobby-sync-status">â¬¤ GitHub Gist åŒæ­¥ä¸­</span>
    </div>
  </div>
  <div class="card" style="max-width:700px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="section-title" style="margin:0">ğŸ‘¥ å·²åŠ å…¥ç©å®¶</div>
      <span class="badge badge-success" id="player-count-badge">0 äºº</span>
    </div>
    <div class="players-grid" id="lobby-players"></div>
    <div class="waiting-anim mt-16"><div class="waiting-dot"></div><div class="waiting-dot"></div><div class="waiting-dot"></div></div>
    <p style="text-align:center;color:var(--text-muted);font-size:0.82rem">ç­‰å¾…ç©å®¶åŠ å…¥ä¸­...</p>
  </div>
  <div class="card" style="max-width:700px">
    <button class="btn btn-primary btn-full btn-lg" onclick="startGame()">â–¶ é–‹å§‹éŠæˆ²</button>
    <p style="text-align:center;font-size:0.78rem;color:var(--text-muted);margin-top:8px">å»ºè­°ç­‰æ‰€æœ‰äººåŠ å…¥å¾Œå†é–‹å§‹</p>
  </div>
</section>

<!-- â•â• HOST QUESTION â•â• -->
<section class="screen" id="screen-host-question">
  <div style="width:100%;max-width:800px;display:flex;flex-direction:column;align-items:center;padding-top:16px">
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;margin-bottom:16px">
      <span id="hq-label" class="badge badge-primary">ç¬¬ 1 / 5 é¡Œ</span>
      <div class="timer-wrap" style="margin:0">
        <div class="timer-ring" id="host-timer-ring">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle class="timer-bg" cx="40" cy="40" r="34"/>
            <circle class="timer-prog" id="host-timer-circle" cx="40" cy="40" r="34"/>
          </svg>
          <div class="timer-num" id="host-timer-num">20</div>
        </div>
      </div>
    </div>
    <div class="q-progress" id="hq-progress"></div>
    <div class="question-box" id="hq-text">å•é¡Œå…§å®¹</div>
    <div class="answered-count" id="hq-answered-count">0 / 0 äººå·²ä½œç­”</div>
    <div class="answered-bar-wrap mt-8" style="max-width:400px"><div class="answered-bar" id="hq-answered-bar" style="width:0%"></div></div>
    <div class="answers-host mt-16" id="hq-answers"></div>
    <button class="btn btn-primary btn-lg mt-24" onclick="endQuestion()" style="min-width:200px">â­ é¡¯ç¤ºçµæœ</button>
  </div>
</section>

<!-- â•â• HOST RESULTS â•â• -->
<section class="screen" id="screen-host-results">
  <div style="width:100%;max-width:700px;padding-top:20px">
    <div class="section-title text-center">ğŸ“Š æœ¬é¡Œçµæœ</div>
    <div id="hr-correct-ans" class="correct-banner" style="margin-bottom:16px"></div>
    <div class="section-subtitle">æ’è¡Œæ¦œ</div>
    <ul class="leaderboard" id="host-leaderboard"></ul>
    <div class="mt-24 text-center">
      <button class="btn btn-primary btn-lg" id="btn-next-q" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â†’</button>
    </div>
  </div>
</section>

<!-- â•â• HOST FINAL â•â• -->
<section class="screen" id="screen-host-final">
  <div style="text-align:center;padding-top:24px;margin-bottom:16px">
    <div class="logo">ğŸ† æœ€çµ‚çµæœ</div>
    <div class="logo-sub">éŠæˆ²çµæŸï¼</div>
  </div>
  <div style="max-width:700px;width:100%">
    <div class="podium" id="final-podium"></div>
    <ul class="leaderboard" id="host-final-leaderboard"></ul>
    <div class="text-center mt-24">
      <button class="btn btn-primary btn-lg" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>
  </div>
</section>

<!-- â•â• PLAYER JOIN â•â• -->
<section class="screen" id="screen-player-join">
  <div style="text-align:center;margin-bottom:32px;padding-top:12vh">
    <div class="logo">âš¡ Q1 POA</div>
    <div class="logo-sub">åŠ å…¥éŠæˆ²</div>
  </div>
  <div class="card">
    <div class="section-title">ğŸ”‘ è¼¸å…¥æˆ¿é–“ç¢¼</div>
    <label>4 ä½æ•¸å­—æˆ¿é–“ç¢¼</label>
    <div class="room-input-group">
      <input class="input-field" id="room-code-input" type="text" placeholder="1234" maxlength="4" pattern="[0-9]*" inputmode="numeric">
      <button class="btn btn-primary" onclick="tryJoinRoom()">ç¢ºèª</button>
    </div>
    <hr class="separator">
    <div class="section-title" style="font-size:1.1rem">ğŸ‘¤ ä½ çš„å§“å</div>
    <input class="input-field" id="player-name-input" type="text" placeholder="ä¾‹ï¼šç‹å°æ˜" maxlength="20"
      onkeydown="if(event.key==='Enter') joinGame()">
    <button class="btn btn-primary btn-full btn-lg mt-16" onclick="joinGame()">ğŸš€ åŠ å…¥éŠæˆ²ï¼</button>
  </div>
  <button class="btn btn-secondary mt-8" onclick="showScreen('screen-home')">â† è¿”å›</button>
</section>

<!-- â•â• PLAYER LOBBY â•â• -->
<section class="screen" id="screen-player-lobby">
  <div style="text-align:center;padding-top:14vh">
    <div class="logo">âš¡ Q1 POA</div>
    <div style="margin-top:10px"><span class="badge badge-success" id="plobby-name-badge">ç©å®¶åç¨±</span></div>
    <div style="margin-top:32px;font-family:'Fredoka One',cursive;font-size:1.3rem;color:var(--text-muted)">ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²</div>
    <div class="waiting-anim mt-16"><div class="waiting-dot"></div><div class="waiting-dot"></div><div class="waiting-dot"></div></div>
    <p style="font-size:0.8rem;color:var(--text-muted);margin-top:16px">ä¸»æŒäººå®£å¸ƒé–‹å§‹å¾Œå°‡è‡ªå‹•é€²å…¥ä½œç­”</p>
  </div>
</section>

<!-- â•â• PLAYER QUESTION â•â• -->
<section class="screen" id="screen-player-question">
  <div style="width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center;padding-top:16px">
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;margin-bottom:16px">
      <span id="pq-label" class="badge badge-primary">ç¬¬ 1 é¡Œ</span>
      <div class="timer-wrap" style="margin:0">
        <div class="timer-ring" id="player-timer-ring">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle class="timer-bg" cx="40" cy="40" r="34"/>
            <circle class="timer-prog" id="player-timer-circle" cx="40" cy="40" r="34"/>
          </svg>
          <div class="timer-num" id="player-timer-num">20</div>
        </div>
      </div>
    </div>
    <div class="question-box" id="pq-text">å•é¡Œå…§å®¹</div>
    <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:14px;font-weight:700">è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ</p>
    <div class="answers-player" id="pq-answers"></div>
  </div>
</section>

<!-- â•â• PLAYER FEEDBACK â•â• -->
<section class="screen" id="screen-player-feedback">
  <div class="feedback-wrap">
    <div class="feedback-icon" id="pf-icon">âœ…</div>
    <div style="font-family:'Fredoka One',cursive;font-size:1.5rem;margin-bottom:8px" id="pf-text">ç­”å°äº†ï¼</div>
    <div class="points-earned" id="pf-points">+850</div>
    <div style="font-size:0.85rem;color:var(--text-muted);font-weight:700;margin-bottom:16px">æœ¬é¡Œå¾—åˆ†</div>
    <div class="player-rank-badge" id="pf-rank">ç›®å‰æ’åï¼šç¬¬ 2 å</div>
    <div class="waiting-anim mt-24"><div class="waiting-dot"></div><div class="waiting-dot"></div><div class="waiting-dot"></div></div>
    <p style="font-size:0.8rem;color:var(--text-muted);margin-top:8px">ç­‰å¾…ä¸‹ä¸€é¡Œ...</p>
  </div>
</section>

<!-- â•â• PLAYER RESULTS â•â• -->
<section class="screen" id="screen-player-results">
  <div style="width:100%;max-width:600px;padding-top:20px">
    <div class="section-title text-center" id="pr-q-result"></div>
    <div id="pr-feedback-banner" style="border-radius:14px;padding:16px 20px;text-align:center;margin-bottom:16px"></div>
    <div class="section-subtitle text-center">ğŸ† æ’è¡Œæ¦œ</div>
    <ul class="leaderboard" id="player-leaderboard"></ul>
    <div class="waiting-anim mt-16"><div class="waiting-dot"></div><div class="waiting-dot"></div><div class="waiting-dot"></div></div>
    <p style="text-align:center;font-size:0.8rem;color:var(--text-muted);margin-top:8px">ç­‰å¾…ä¸‹ä¸€é¡Œ...</p>
  </div>
</section>

<!-- â•â• PLAYER FINAL â•â• -->
<section class="screen" id="screen-player-final">
  <div style="text-align:center;padding-top:12vh">
    <div class="logo">ğŸ† éŠæˆ²çµæŸ</div>
    <div class="logo-sub" id="pfinal-sub">æ„Ÿè¬åƒèˆ‡ï¼</div>
  </div>
  <div style="max-width:600px;width:100%">
    <div class="card text-center mt-16">
      <div id="pfinal-rank-icon" style="font-size:4rem;margin-bottom:12px">ğŸ‰</div>
      <div style="font-family:'Fredoka One',cursive;font-size:1.3rem;margin-bottom:4px" id="pfinal-msg">å¤ªæ£’äº†ï¼</div>
      <div class="points-earned" id="pfinal-score">0</div>
      <div style="font-size:0.85rem;color:var(--text-muted);font-weight:700">æœ€çµ‚å¾—åˆ†</div>
      <div class="player-rank-badge mt-16" id="pfinal-rank">æœ€çµ‚æ’åï¼šç¬¬ 1 å</div>
    </div>
    <ul class="leaderboard mt-16" id="player-final-leaderboard"></ul>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â• -->
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â‘  åœ¨é€™è£¡å¡«å…¥ä½ çš„ GitHub Tokenï¼ˆæˆ–è®“ä¸»æŒäººé€éä»‹é¢è¼¸å…¥ï¼‰
//  æ ¼å¼ï¼šghp_xxxxxxxxxxxxxxxxxxxxxxxx
//  åªéœ€è¦ gist æ¬Šé™
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HARDCODED_TOKEN = ''; // â† å¯ä»¥å¡«åœ¨é€™è£¡ï¼Œæˆ–ç•™ç©ºè®“ä¸»æŒäººåœ¨ä»‹é¢è¼¸å…¥

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GitHub Gist API åŒæ­¥å±¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let GITHUB_TOKEN = HARDCODED_TOKEN;
let gistId = null;          // å»ºç«‹å¾Œçš„ Gist ID
let gistCache = null;       // æœ¬åœ°å¿«å–ï¼Œé¿å…é »ç¹è®€å–
let gistEtag = '';          // ç”¨ ETag åšæ¢ä»¶è®€å–

const GIST_FILENAME = 'quizgame_state.json';
const GIST_API = 'https://api.github.com/gists';

// å»ºç«‹æ–° Gistï¼ˆä¸»æŒäººç«¯ï¼‰
async function gistCreate(data) {
  const res = await fetch(GIST_API, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${GITHUB_TOKEN}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github+json',
      'X-GitHub-Api-Version': '2022-11-28'
    },
    body: JSON.stringify({
      description: 'QuizGame Room Data',
      public: true,
      files: { [GIST_FILENAME]: { content: JSON.stringify(data) } }
    })
  });
  if (!res.ok) throw new Error(`Gist create failed: ${res.status}`);
  const json = await res.json();
  return json.id;
}

// æ›´æ–° Gistï¼ˆä¸»æŒäººç«¯ï¼‰
async function gistUpdate(data) {
  if (!gistId) throw new Error('No gistId');
  const res = await fetch(`${GIST_API}/${gistId}`, {
    method: 'PATCH',
    headers: {
      'Authorization': `Bearer ${GITHUB_TOKEN}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github+json',
      'X-GitHub-Api-Version': '2022-11-28'
    },
    body: JSON.stringify({
      files: { [GIST_FILENAME]: { content: JSON.stringify(data) } }
    })
  });
  if (!res.ok) throw new Error(`Gist update failed: ${res.status}`);
  gistCache = data;
}

// è®€å– Gistï¼ˆæ‰€æœ‰è£ç½®ï¼Œä¸éœ€ Tokenï¼‰
// _urlToken: Token å¾ URL åƒæ•¸å‚³çµ¦ç©å®¶ç«¯ï¼ˆä¸»æŒäººç”¢ç”Ÿ QR æ™‚åµŒå…¥ï¼‰
let _urlToken = '';

// è®€å– Gist â€” public gist ä¸éœ€ Tokenï¼Œå¸¶ Token å¯é¿å… rate limit
async function gistRead(id) {
  const headers = {
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version': '2022-11-28',
  };
  const tok = GITHUB_TOKEN || _urlToken;
  if (tok) headers['Authorization'] = `Bearer ${tok}`;
  const res = await fetch(`${GIST_API}/${id}?_=${Date.now()}`, { headers, cache: 'no-store' });
  if (!res.ok) throw new Error(`Gist read failed: ${res.status}`);
  const json = await res.json();
  const raw = json.files?.[GIST_FILENAME]?.content;
  return raw ? JSON.parse(raw) : null;
}

// â”€â”€ é«˜éš store APIï¼ˆä½¿ç”¨ Gist ä½œç‚ºå¾Œç«¯ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// data çµæ§‹ï¼š{ state, players, questions, answers: { "0": {...}, "1": {...} } }

async function writeGist(patch) {
  const current = gistCache || { state: null, players: {}, questions: [], answers: {} };
  const merged = { ...current, ...patch };
  gistCache = merged;
  await gistUpdate(merged);
}

async function readGist() {
  if (!gistId) return null;
  const data = await gistRead(gistId);
  gistCache = data;
  return data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å¸¸æ•¸ & æ‡‰ç”¨ç‹€æ…‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHAPES = ['â–²','â– ','â—','âœ¦'];
const AVATAR_COLORS = ['#7c6dfa','#1a9bfc','#f5a623','#2eb872','#e8344a','#ff7eb6','#4fd1f5'];

const DEFAULT_QUESTIONS = [
  { question: "Livaloï¼ˆpitavastatinï¼‰ä¸»è¦çš„é©æ‡‰ç—‡ç‚ºï¼Ÿ", options: ["é™ä½ä¸‰é…¸ç”˜æ²¹é…¯","é™ä½LDLè†½å›ºé†‡","å‡é«˜HDLè†½å›ºé†‡","æ§åˆ¶è¡€ç³–"], correct: 1, time: 20 },
  { question: "Livazebeæ˜¯ä¸‹åˆ—å“ªå…©ç¨®æˆåˆ†çš„è¤‡æ–¹è£½åŠ‘ï¼Ÿ", options: ["Pitavastatin + Ezetimibe","Rosuvastatin + Ezetimibe","Atorvastatin + Fenofibrate","Pitavastatin + Fenofibrate"], correct: 0, time: 20 },
  { question: "Pitavastatinçš„å»ºè­°æœè—¥æ™‚é–“ç‚ºï¼Ÿ", options: ["å¿…é ˆæ—©é¤å¾Œæœç”¨","å¿…é ˆç¡å‰æœç”¨","ä»»ä½•æ™‚é–“çš†å¯ï¼Œä¸å—é£Ÿç‰©å½±éŸ¿","å¿…é ˆç©ºè…¹æœç”¨"], correct: 2, time: 20 },
  { question: "ä½¿ç”¨Statiné¡è—¥ç‰©æœ€éœ€ç›£æ¸¬çš„å‰¯ä½œç”¨æ˜¯ï¼Ÿ", options: ["è…æ¯’æ€§","è‚Œè‚‰ç—…è®Šï¼ˆè‚Œç—›ã€æ©«ç´‹è‚Œæº¶è§£ï¼‰","è¦–åŠ›æ¨¡ç³Š","çš®è†šå…‰æ•æ„Ÿ"], correct: 1, time: 20 },
  { question: "Ezetimibeçš„ä½œç”¨æ©Ÿåˆ¶æ˜¯ï¼Ÿ", options: ["æŠ‘åˆ¶HMG-CoAé‚„åŸé…¶","æŠ‘åˆ¶è…¸é“è†½å›ºé†‡å¸æ”¶","æ´»åŒ–PPAR-alpha","æŠ‘åˆ¶PCSK9"], correct: 1, time: 20 },
  { question: "Livaloèˆ‡Livazebeç›¸æ¯”ï¼ŒLivazebeé¡å¤–æä¾›çš„å„ªé»æ˜¯ï¼Ÿ", options: ["æ›´å¼·æ•ˆé™LDL","åŒæ™‚é™ä½LDLèˆ‡è†½å›ºé†‡å¸æ”¶ï¼ŒåŠ ä¹˜æ•ˆæœ","å¯é™ä½ä¸‰é…¸ç”˜æ²¹é…¯","é©åˆè…åŠŸèƒ½ä¸å…¨æ‚£è€…"], correct: 1, time: 20 },
];

let mode = null;
let myName = '';
let myRoom = '';         // 4ä½æˆ¿é–“ç¢¼ï¼ˆå°æ‡‰ Gist ID çš„çŸ­ç¢¼ï¼‰
let questions = [];
let editCorrect = 0;
let editTime = 20;
let pollTimer = null;
let questionTimer = null;
let playerTimerInterval = null;
let currentQIndex = 0;
let myAnsweredQIndex = -1;
let myLastScore = 0;
let totalPlayers = 0;
let lastShownQIndex = -99;
let lastResultsQIndex = -99;
let shownFinal = false;
let hostQStartTime = 0;

// æˆ¿é–“ç¢¼ â†’ Gist ID çš„æ˜ å°„ï¼ˆç©å®¶ç«¯ç”¨ï¼‰
// æ ¼å¼å­˜åœ¨ localStorageï¼ˆåƒ…åšæœ¬æ©Ÿå¿«å–ï¼Œè‹¥æ›è£ç½®æœƒç›´æ¥å¾ URL åƒæ•¸å–å¾—ï¼‰
function saveRoomMapping(code, id) {
  try { localStorage.setItem(`qb_room_${code}`, id); } catch {}
}
function loadRoomMapping(code) {
  try { return localStorage.getItem(`qb_room_${code}`); } catch { return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI å·¥å…·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function toast(msg) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2800);
}
function avatarColor(name) {
  let h = 0;
  for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) & 0xfffff;
  return AVATAR_COLORS[h % AVATAR_COLORS.length];
}
function initials(name) { return name.slice(0, 2).toUpperCase(); }
function rankLabel(r) {
  if (r === 1) return 'ğŸ¥‡'; if (r === 2) return 'ğŸ¥ˆ'; if (r === 3) return 'ğŸ¥‰'; return `#${r}`;
}
function launchConfetti() {
  const colors = ['#7c6dfa','#feca57','#ff6b6b','#4fd1f5','#ff9ff3','#2ecc71'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.background = colors[Math.floor(Math.random() * colors.length)];
    el.style.animationDuration = (1.5 + Math.random() * 2) + 's';
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}
function setTokenStatus(state, msg) {
  const el = document.getElementById('token-status');
  if (!el) return;
  el.className = `sync-status ${state}`;
  el.textContent = { ok: 'â¬¤ ', err: 'â¬¤ ', idle: 'â¬¤ ' }[state] + msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Token ç®¡ç†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function applyToken() {
  const input = document.getElementById('github-token-input');
  const token = input.value.trim();
  if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
    return toast('âš ï¸ Token æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚º ghp_ æˆ– github_pat_ é–‹é ­');
  }
  GITHUB_TOKEN = token;
  setTokenStatus('idle', 'é©—è­‰ä¸­...');
  // æ¸¬è©¦ Token æ˜¯å¦æœ‰æ•ˆ
  try {
    const res = await fetch('https://api.github.com/gists?per_page=1', {
      headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github+json' }
    });
    if (res.ok) {
      setTokenStatus('ok', 'Token æœ‰æ•ˆ âœ“');
      toast('âœ… Token é©—è­‰æˆåŠŸï¼');
      input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†ä¿è­·å®‰å…¨
    } else {
      GITHUB_TOKEN = '';
      setTokenStatus('err', 'Token ç„¡æ•ˆ');
      toast('âŒ Token ç„¡æ•ˆï¼Œè«‹é‡æ–°ç¢ºèª');
    }
  } catch(e) {
    setTokenStatus('err', 'ç¶²è·¯éŒ¯èª¤');
    toast('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¢ºèªé€£ç·š');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QR Code
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildJoinUrl(room, gid) {
  const base = window.location.href.split('?')[0].split('#')[0];
  // æŠŠ token çš„å¾Œ16ç¢¼åµŒå…¥ URL è®“ç©å®¶ç«¯å¯è®€å¯« Gistï¼ˆå®Œæ•´ token åœ¨ URL ä¸­ï¼Œè«‹å‹¿å…¬é–‹åˆ†äº«é€£çµï¼‰
  const tok = GITHUB_TOKEN ? encodeURIComponent(GITHUB_TOKEN) : '';
  return `${base}?room=${room}&gid=${gid}${tok ? '&t=' + tok : ''}`;
}
function genQR(containerId, url) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  setTimeout(() => {
    try {
      new QRCode(el, { text: url, width: 180, height: 180, colorDark: '#000000', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
    } catch(e) { el.innerHTML = '<p style="color:red">QRç”¢ç”Ÿå¤±æ•—</p>'; }
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  é¡Œç›®ç·¨è¼¯å™¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildEditorOptions() {
  const grid = document.getElementById('ed-options-grid');
  grid.innerHTML = '';
  ['A','B','C','D'].forEach((lbl, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'opt-input-wrap' + (i === editCorrect ? ' correct-opt' : '');
    wrap.id = `opt-wrap-${i}`;
    wrap.onclick = () => setCorrect(i);
    wrap.innerHTML = `<span class="opt-badge ${['a','b','c','d'][i]}">${lbl}</span>
      <div style="flex:1"><input type="text" id="opt-input-${i}" placeholder="é¸é … ${lbl}..." onclick="event.stopPropagation()">
      <div class="correct-label">âœ“ æ­£ç¢ºç­”æ¡ˆ</div></div>`;
    grid.appendChild(wrap);
  });
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.t) === editTime);
    btn.onclick = () => { editTime = parseInt(btn.dataset.t); document.querySelectorAll('.time-btn').forEach(b => b.classList.toggle('active', b === btn)); };
  });
}
function setCorrect(i) {
  editCorrect = i;
  for (let j = 0; j < 4; j++) document.getElementById(`opt-wrap-${j}`).classList.toggle('correct-opt', j === i);
}
function resetEditor() {
  document.getElementById('ed-question').value = '';
  for (let i = 0; i < 4; i++) document.getElementById(`opt-input-${i}`).value = '';
  editCorrect = 0; editTime = 20; buildEditorOptions();
}
function saveCurrentQuestion() {
  const q = document.getElementById('ed-question').value.trim();
  if (!q) return toast('âš ï¸ è«‹è¼¸å…¥å•é¡Œå…§å®¹');
  const opts = [];
  for (let i = 0; i < 4; i++) {
    const v = document.getElementById(`opt-input-${i}`).value.trim();
    if (!v) return toast(`âš ï¸ è«‹å¡«å¯«é¸é … ${['A','B','C','D'][i]}`);
    opts.push(v);
  }
  questions.push({ question: q, options: opts, correct: editCorrect, time: editTime });
  renderQuestionList(); resetEditor(); toast('âœ… é¡Œç›®å·²å„²å­˜');
}
function renderQuestionList() {
  const ul = document.getElementById('q-list');
  ul.innerHTML = '';
  questions.forEach((q, i) => {
    const li = document.createElement('li'); li.className = 'q-item';
    li.innerHTML = `<span class="q-num">${i+1}</span>
      <span class="q-text">${q.question.length > 50 ? q.question.slice(0,50)+'â€¦' : q.question}</span>
      <span style="font-size:0.75rem;color:var(--text-muted);margin-right:4px">${q.time}ç§’</span>
      <button class="q-del" onclick="deleteQuestion(event,${i})">âœ•</button>`;
    ul.appendChild(li);
  });
}
function deleteQuestion(e, i) { e.stopPropagation(); questions.splice(i, 1); renderQuestionList(); }
function loadDefaultQuestions() {
  questions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
  renderQuestionList(); toast('ğŸ“¦ å·²è¼‰å…¥ ' + questions.length + ' é“ç¯„ä¾‹é¡Œç›®');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOST MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterHostMode() {
  mode = 'host';
  if (HARDCODED_TOKEN) {
    GITHUB_TOKEN = HARDCODED_TOKEN;
    setTokenStatus('ok', 'Token å·²è¼‰å…¥ âœ“');
  }
  buildEditorOptions();
  showScreen('screen-host-setup');
}

async function startLobby() {
  if (!GITHUB_TOKEN) return toast('âš ï¸ è«‹å…ˆè¼¸å…¥ GitHub Token');
  if (questions.length === 0) return toast('âš ï¸ è«‹å…ˆæ–°å¢è‡³å°‘ä¸€é“é¡Œç›®');

  toast('â³ æ­£åœ¨å»ºç«‹æˆ¿é–“...');
  try {
    const initData = {
      state: { phase: 'lobby', qIndex: 0, qStart: 0, qTime: 0, totalQ: questions.length },
      players: {},
      questions: questions,
      answers: {}
    };
    gistId = await gistCreate(initData);
    gistCache = initData;

    // 4ä½æˆ¿é–“ç¢¼ï¼šå– gistId æœ€å¾Œ4ç¢¼ï¼ˆç´”æ•¸å­—éƒ¨åˆ†ï¼‰
    myRoom = gistId.replace(/[^0-9]/g, '').slice(-4) || String(Date.now()).slice(-4);
    saveRoomMapping(myRoom, gistId);

    document.getElementById('host-room-code').textContent = myRoom;
    const url = buildJoinUrl(myRoom, gistId);
    genQR('qrcode2', url);
    document.getElementById('join-url-text2').textContent = url;

    showScreen('screen-host-lobby');
    startHostLobbyPoll();
    toast('âœ… æˆ¿é–“å·²é–‹å•Ÿï¼');
  } catch(e) {
    toast('âŒ å»ºç«‹æˆ¿é–“å¤±æ•—ï¼š' + e.message);
    console.error(e);
  }
}

function startHostLobbyPoll() {
  clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const data = await readGist();
      if (!data) return;
      const players = data.players || {};
      const names = Object.keys(players);
      totalPlayers = names.length;
      document.getElementById('player-count-badge').textContent = names.length + ' äºº';
      const grid = document.getElementById('lobby-players');
      const existing = [...grid.querySelectorAll('.player-chip')].map(c => c.dataset.name);
      names.forEach(name => {
        if (!existing.includes(name)) {
          const chip = document.createElement('div');
          chip.className = 'player-chip'; chip.dataset.name = name;
          chip.innerHTML = `<div class="player-avatar" style="background:${avatarColor(name)}">${initials(name)}</div>${name}`;
          grid.appendChild(chip);
        }
      });
      document.getElementById('lobby-sync-status').className = 'sync-status ok';
      document.getElementById('lobby-sync-status').textContent = 'â¬¤ GitHub Gist åŒæ­¥ä¸­';
    } catch(e) {
      document.getElementById('lobby-sync-status').className = 'sync-status err';
      document.getElementById('lobby-sync-status').textContent = 'â¬¤ åŒæ­¥å¤±æ•—ï¼Œé‡è©¦ä¸­...';
    }
  }, 2000);
}

async function startGame() {
  const data = gistCache;
  if (!data || Object.keys(data.players || {}).length === 0) return toast('âš ï¸ ç­‰å¾…è‡³å°‘ä¸€ä½ç©å®¶åŠ å…¥');
  clearInterval(pollTimer);
  currentQIndex = 0;
  await showHostQuestion();
}

async function showHostQuestion() {
  const q = questions[currentQIndex];
  hostQStartTime = Date.now();
  const state = { phase: 'question', qIndex: currentQIndex, qStart: hostQStartTime, qTime: q.time, totalQ: questions.length };

  // æ¸…é™¤æœ¬é¡Œç­”æ¡ˆ
  const data = gistCache || {};
  const answers = data.answers || {};
  delete answers[String(currentQIndex)];
  await writeGist({ state, answers });

  // é€²åº¦é»
  const prog = document.getElementById('hq-progress');
  prog.innerHTML = '';
  for (let i = 0; i < questions.length; i++) {
    const d = document.createElement('div');
    d.className = 'q-dot' + (i < currentQIndex ? ' done' : i === currentQIndex ? ' active' : '');
    prog.appendChild(d);
  }
  document.getElementById('hq-label').textContent = `ç¬¬ ${currentQIndex+1} / ${questions.length} é¡Œ`;
  document.getElementById('hq-text').textContent = q.question;

  const wrap = document.getElementById('hq-answers');
  wrap.innerHTML = '';
  q.options.forEach((opt, i) => {
    const div = document.createElement('div'); div.className = 'ans-btn-host'; div.dataset.opt = i;
    div.innerHTML = `<div class="ans-shape">${SHAPES[i]}</div><span>${opt}</span>`;
    wrap.appendChild(div);
  });

  const players = gistCache?.players || {};
  totalPlayers = Object.keys(players).length;
  document.getElementById('hq-answered-count').textContent = `0 / ${totalPlayers} äººå·²ä½œç­”`;
  document.getElementById('hq-answered-bar').style.width = '0%';

  showScreen('screen-host-question');
  runHostTimer(q.time, hostQStartTime);
  startAnswerPoll();
}

function runHostTimer(seconds, startTime) {
  const circle = document.getElementById('host-timer-circle');
  const numEl = document.getElementById('host-timer-num');
  const ring = document.getElementById('host-timer-ring');
  const circumference = 213.6;
  let autoEnded = false;
  clearInterval(questionTimer);
  questionTimer = setInterval(() => {
    const elapsed = (Date.now() - startTime) / 1000;
    const remaining = Math.max(0, seconds - elapsed);
    numEl.textContent = Math.ceil(remaining);
    circle.style.strokeDashoffset = circumference * (1 - remaining / seconds);
    ring.classList.toggle('urgent', remaining <= 5);
    if (remaining <= 0 && !autoEnded) { autoEnded = true; clearInterval(questionTimer); setTimeout(endQuestion, 500); }
  }, 100);
}

function startAnswerPoll() {
  clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const data = await readGist();
      const answers = data?.answers?.[String(currentQIndex)] || {};
      const count = Object.keys(answers).length;
      document.getElementById('hq-answered-count').textContent = `${count} / ${totalPlayers} äººå·²ä½œç­”`;
      document.getElementById('hq-answered-bar').style.width = (totalPlayers > 0 ? count/totalPlayers*100 : 0) + '%';
    } catch {}
  }, 2000);
}

async function endQuestion() {
  clearInterval(questionTimer);
  clearInterval(pollTimer);

  const data = await readGist();
  const q = questions[currentQIndex];
  const answers = data?.answers?.[String(currentQIndex)] || {};
  let players = data?.players || {};

  Object.entries(answers).forEach(([name, ans]) => {
    if (!players[name]) players[name] = { score: 0, totalScore: 0 };
    let pts = 0;
    if (ans.answer === q.correct) {
      const elapsed = Math.max(0, (ans.time - hostQStartTime) / 1000);
      pts = Math.round(500 + 500 * Math.max(0, 1 - (elapsed / q.time) * 0.5));
    }
    players[name].score = pts;
    players[name].totalScore = (players[name].totalScore || 0) + pts;
  });
  Object.keys(players).forEach(name => { if (!(name in answers)) players[name].score = 0; });

  await writeGist({ state: { phase: 'results', qIndex: currentQIndex, qStart: 0, qTime: 0, totalQ: questions.length }, players });
  showHostResults(q, players);
}

function showHostResults(q, players) {
  document.getElementById('hr-correct-ans').innerHTML =
    `<div style="font-size:0.8rem;color:rgba(255,255,255,0.8);margin-bottom:4px;font-weight:700;letter-spacing:1px">æ­£ç¢ºç­”æ¡ˆ</div>
     <div style="font-family:'Fredoka One',cursive;font-size:1.4rem">${SHAPES[q.correct]} ${q.options[q.correct]}</div>`;

  const sorted = Object.entries(players)
    .map(([name, d]) => ({ name, totalScore: d.totalScore||0, score: d.score||0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  const ul = document.getElementById('host-leaderboard');
  ul.innerHTML = '';
  sorted.slice(0, 8).forEach((p, i) => {
    const li = document.createElement('li'); li.className = 'lb-item'; li.style.animationDelay = (i*0.08)+'s';
    li.innerHTML = `<div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}</div>
      <div class="lb-score">${p.totalScore.toLocaleString()}</div>
      ${p.score > 0 ? `<div class="lb-delta">+${p.score}</div>` : ''}`;
    ul.appendChild(li);
  });
  document.getElementById('btn-next-q').textContent = currentQIndex >= questions.length-1 ? 'ğŸ† æŸ¥çœ‹æœ€çµ‚çµæœ' : 'ä¸‹ä¸€é¡Œ â†’';
  showScreen('screen-host-results');
}

async function nextQuestion() {
  if (currentQIndex >= questions.length - 1) { await showFinalResults(); return; }
  currentQIndex++; await showHostQuestion();
}

async function showFinalResults() {
  await writeGist({ state: { phase: 'final', qIndex: currentQIndex, qStart: 0, qTime: 0, totalQ: questions.length } });
  const players = gistCache?.players || {};
  const sorted = Object.entries(players).map(([name, d]) => ({ name, totalScore: d.totalScore||0 })).sort((a,b) => b.totalScore - a.totalScore);

  const podium = document.getElementById('final-podium');
  podium.innerHTML = '';
  [1, 0, 2].forEach((rank, pi) => {
    const p = sorted[rank]; if (!p) return;
    const div = document.createElement('div'); div.className = 'podium-item';
    div.innerHTML = `<div class="podium-name">${p.name}</div>
      <div class="podium-score">${p.totalScore.toLocaleString()}</div>
      <div class="podium-base ${['second','first','third'][pi]}">${rankLabel(rank+1)}</div>`;
    podium.appendChild(div);
  });

  const ul = document.getElementById('host-final-leaderboard');
  ul.innerHTML = '';
  sorted.forEach((p, i) => {
    const li = document.createElement('li'); li.className = 'lb-item'; li.style.animationDelay = (i*0.07)+'s';
    li.innerHTML = `<div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}</div><div class="lb-score">${p.totalScore.toLocaleString()}</div>`;
    ul.appendChild(li);
  });
  showScreen('screen-host-final'); launchConfetti();
}

async function restartGame() {
  clearInterval(pollTimer); clearInterval(questionTimer);
  gistId = null; gistCache = null; questions = [];
  renderQuestionList(); resetEditor(); showScreen('screen-host-setup');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function tryJoinRoom() {
  const code = document.getElementById('room-code-input').value.trim();
  if (code.length !== 4 || isNaN(code)) return toast('âš ï¸ è«‹è¼¸å…¥ 4 ä½æ•¸å­—æˆ¿é–“ç¢¼');

  // å˜—è©¦å–å¾— gistIdï¼ˆURL åƒæ•¸ > localStorage > æç¤ºç”¨ QR Codeï¼‰
  const params = new URLSearchParams(window.location.search);
  let gid = params.get('gid') || loadRoomMapping(code);
  if (!gid) {
    // è‹¥ gistId å·²åœ¨è¨˜æ†¶é«”ï¼ˆå¾ URL å¸¶å…¥å¾Œè¢«è¨­å®šï¼‰
    if (gistId) { gid = gistId; saveRoomMapping(code, gid); }
    else return toast('âš ï¸ æ‰¾ä¸åˆ°æ­¤æˆ¿é–“ï¼Œè«‹ç”¨ä¸»æŒäººçš„ QR Code æƒæåŠ å…¥');
  }

  try {
    const data = await gistRead(gid);
    if (!data) return toast('âš ï¸ æˆ¿é–“è³‡æ–™è®€å–å¤±æ•—');
    if (data.state?.phase === 'final') return toast('âš ï¸ æ­¤éŠæˆ²å·²çµæŸ');
    saveRoomMapping(code, gid);
    gistId = gid;
    toast('âœ… æ‰¾åˆ°æˆ¿é–“ï¼è«‹è¼¸å…¥å§“åå¾ŒåŠ å…¥');
  } catch(e) {
    toast('âš ï¸ æ‰¾ä¸åˆ°æ­¤æˆ¿é–“ï¼Œè«‹ç¢ºèªæˆ¿é–“ç¢¼');
  }
}

async function joinGame() {
  const code = document.getElementById('room-code-input').value.trim();
  const name = document.getElementById('player-name-input').value.trim();
  if (code.length !== 4 || isNaN(code)) return toast('âš ï¸ è«‹è¼¸å…¥ 4 ä½æ•¸å­—æˆ¿é–“ç¢¼');
  if (!name) return toast('âš ï¸ è«‹è¼¸å…¥ä½ çš„å§“å');

  // å–å¾— gistId
  const params = new URLSearchParams(window.location.search);
  let gid = params.get('gid') || loadRoomMapping(code) || gistId;
  if (!gid) return toast('âš ï¸ è«‹å…ˆé»ã€Œç¢ºèªã€é©—è­‰æˆ¿é–“ç¢¼');

  try {
    const data = await gistRead(gid);
    if (!data) return toast('âš ï¸ ç„¡æ³•è®€å–æˆ¿é–“è³‡æ–™');
    if (data.state?.phase === 'final') return toast('âš ï¸ æ­¤éŠæˆ²å·²çµæŸ');

    myName = name; myRoom = code; mode = 'player'; gistId = gid;
    myAnsweredQIndex = -1; lastShownQIndex = -99; lastResultsQIndex = -99; shownFinal = false;
    if (data.questions) questions = data.questions;

    // å¯«å…¥ç©å®¶ï¼ˆç©å®¶ç«¯ä¹Ÿè¦èƒ½å¯« Gist â€” å› ç‚ºç©å®¶æ²’æœ‰ Tokenï¼Œæˆ‘å€‘ç”¨ä¸»æŒäºº Token çš„ public gist è®“ç©å®¶è®€ï¼Œä½†ç©å®¶ç­”é¡Œéœ€è¦å¦å¤–è¨­è¨ˆï¼‰
    // è§£æ³•ï¼šç©å®¶ç­”æ¡ˆç›´æ¥é™„åŠ åˆ° Gistï¼›å› ç‚ºç©å®¶æ²’æœ‰ Tokenï¼Œæ”¹ç”±ç©å®¶çš„ç­”æ¡ˆå…ˆæš«å­˜åœ¨ URLï¼Œç”±ä¸»æŒäººè¼ªè©¢ â”€ ä¸å¯è¡Œ
    // âœ… å¯¦éš›å¯è¡Œè§£ï¼šGist è¨­ç‚º publicï¼Œç©å®¶ç”¨ç„¡èªè­‰è®€ï¼›ç©å®¶ç­”é¡Œé€é HARDCODED_TOKEN æˆ–è¦æ±‚ç©å®¶æ²’æœ‰ Token
    // â†’ æˆ‘å€‘çµ±ä¸€ç”¨ HARDCODED_TOKEN åš writeï¼Œç©å®¶ç«¯ç­”é¡Œä¹Ÿé€ PATCHï¼ˆå› ç‚º Token å·² hardcode åœ¨é é¢ï¼‰
    // è‹¥ Token æ˜¯ hardcodeï¼Œç©å®¶ç«¯å¯ä»¥ç›´æ¥ç”¨å®ƒå¯«å…¥ï¼›è‹¥åªæœ‰ä¸»æŒäººè¼¸å…¥ï¼Œç©å®¶ç«¯éœ€è¦é€é URL å¸¶ tokenï¼ˆä¸å®‰å…¨ï¼‰
    // â†’ æœ€å®‰å…¨åšæ³•ï¼šæŠŠ Token hardcode åœ¨ HARDCODED_TOKEN å¸¸æ•¸å³å¯

    if (!GITHUB_TOKEN && !HARDCODED_TOKEN) {
      toast('âš ï¸ æ³¨æ„ï¼šæ²’æœ‰ Tokenï¼Œç„¡æ³•æäº¤ç­”æ¡ˆã€‚è«‹å‘ä¸»æŒäººç¢ºèªè¨­å®šã€‚');
    }

    // å¯«å…¥ç©å®¶æ¸…å–®
    const players = data.players || {};
    if (!players[name]) {
      players[name] = { score: 0, totalScore: 0, joined: Date.now() };
      await gistUpdate({ ...data, players });
      gistCache = { ...data, players };
    } else {
      gistCache = data;
    }

    document.getElementById('plobby-name-badge').textContent = 'ğŸ‘¤ ' + name;
    toast('âœ… æˆåŠŸåŠ å…¥ï¼');
    // æ¸…é™¤ URL åƒæ•¸
    history.replaceState(null, '', window.location.pathname);
    showScreen('screen-player-lobby');
    startPlayerPoll();
  } catch(e) {
    toast('âŒ åŠ å…¥å¤±æ•—ï¼š' + e.message);
    console.error(e);
  }
}

function startPlayerPoll() {
  clearInterval(pollTimer);
  pollTimer = setInterval(playerPollTick, 2000);
}

async function playerPollTick() {
  if (!gistId) return;
  try {
    const data = await gistRead(gistId);
    if (!data?.state) return;
    const state = data.state;

    if (state.phase === 'lobby') {
      if (!document.getElementById('screen-player-lobby').classList.contains('active')) showScreen('screen-player-lobby');
      return;
    }
    if (state.phase === 'question') {
      currentQIndex = state.qIndex;
      if (myAnsweredQIndex === state.qIndex) {
        if (!document.getElementById('screen-player-feedback').classList.contains('active')) showScreen('screen-player-feedback');
        return;
      }
      if (lastShownQIndex !== state.qIndex) {
        if (data.questions) questions = data.questions;
        showPlayerQuestion(state);
      }
      return;
    }
    if (state.phase === 'results') {
      currentQIndex = state.qIndex;
      if (lastResultsQIndex !== state.qIndex) await showPlayerResults(state.qIndex, data);
      return;
    }
    if (state.phase === 'final') {
      if (!shownFinal) await showPlayerFinal(data);
      return;
    }
  } catch(e) { console.warn('Poll error:', e); }
}

function showPlayerQuestion(state) {
  lastShownQIndex = state.qIndex;
  const q = questions[state.qIndex]; if (!q) return;
  document.getElementById('pq-label').textContent = `ç¬¬ ${state.qIndex+1} / ${state.totalQ} é¡Œ`;
  document.getElementById('pq-text').textContent = q.question;
  const wrap = document.getElementById('pq-answers');
  wrap.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'ans-btn-player'; btn.dataset.opt = i;
    btn.innerHTML = `<span class="shape-icon">${SHAPES[i]}</span><span>${opt}</span>`;
    btn.onclick = () => playerAnswer(i, state);
    wrap.appendChild(btn);
  });
  showScreen('screen-player-question');
  runPlayerTimer(state);
}

function runPlayerTimer(state) {
  const circle = document.getElementById('player-timer-circle');
  const numEl = document.getElementById('player-timer-num');
  const ring = document.getElementById('player-timer-ring');
  const circumference = 213.6;
  clearInterval(playerTimerInterval);
  playerTimerInterval = setInterval(() => {
    const elapsed = (Date.now() - state.qStart) / 1000;
    const remaining = Math.max(0, state.qTime - elapsed);
    numEl.textContent = Math.ceil(remaining);
    circle.style.strokeDashoffset = circumference * (1 - remaining / state.qTime);
    ring.classList.toggle('urgent', remaining <= 5);
    if (remaining <= 0) { clearInterval(playerTimerInterval); document.querySelectorAll('.ans-btn-player').forEach(b => b.classList.add('disabled')); }
  }, 100);
}

async function playerAnswer(optIndex, state) {
  if (myAnsweredQIndex === state.qIndex) return;
  myAnsweredQIndex = state.qIndex;
  clearInterval(playerTimerInterval);
  document.querySelectorAll('.ans-btn-player').forEach((b, i) => { b.classList.add('disabled'); if (i === optIndex) b.classList.add('selected'); });

  // å¯«å…¥ç­”æ¡ˆ
  try {
    const data = await gistRead(gistId);
    const answers = data?.answers || {};
    if (!answers[String(state.qIndex)]) answers[String(state.qIndex)] = {};
    answers[String(state.qIndex)][myName] = { answer: optIndex, time: Date.now() };
    await gistUpdate({ ...data, answers });
    gistCache = { ...data, answers };
  } catch(e) { console.warn('Answer write error:', e); }

  const q = questions[state.qIndex];
  const elapsed = (Date.now() - state.qStart) / 1000;
  const isCorrect = optIndex === q.correct;
  let pts = 0;
  if (isCorrect) pts = Math.round(500 + 500 * Math.max(0, 1 - (elapsed / state.qTime) * 0.5));
  myLastScore = pts;

  document.getElementById('pf-icon').textContent = isCorrect ? 'ğŸ‰' : 'ğŸ˜¢';
  document.getElementById('pf-text').textContent = isCorrect ? 'ç­”å°äº†ï¼' : 'ç­”éŒ¯äº†...';
  document.getElementById('pf-points').textContent = `+${pts}`;
  document.getElementById('pf-rank').textContent = 'ç­‰å¾…ä¸»æŒäººå…¬ä½ˆ...';
  if (isCorrect) launchConfetti();
  showScreen('screen-player-feedback');
}

async function showPlayerResults(qIndex, data) {
  lastResultsQIndex = qIndex;
  const q = questions[qIndex];
  const players = data?.players || {};
  const answers = data?.answers?.[String(qIndex)] || {};
  const myAns = answers[myName];
  const isCorrect = myAns && myAns.answer === q.correct;

  document.getElementById('pr-q-result').textContent = `ç¬¬ ${qIndex+1} é¡Œçµæœ`;
  const banner = document.getElementById('pr-feedback-banner');
  if (!myAns) {
    banner.style.background = 'rgba(255,255,255,0.08)';
    banner.innerHTML = `<div style="font-size:1.3rem">âŒ›</div><div>æœªä½œç­”</div>`;
  } else if (isCorrect) {
    banner.style.background = 'linear-gradient(135deg,#2eb872,#22965b)';
    banner.innerHTML = `<div style="font-size:1.3rem">âœ…</div><div style="font-family:'Fredoka One',cursive">ç­”å°äº†ï¼ +${myLastScore}</div>`;
  } else {
    banner.style.background = 'linear-gradient(135deg,#e8344a,#c02336)';
    banner.innerHTML = `<div style="font-size:1.3rem">âŒ</div><div style="font-family:'Fredoka One',cursive">ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆï¼š${q.options[q.correct]}</div>`;
  }

  const sorted = Object.entries(players).map(([name, d]) => ({ name, totalScore: d.totalScore||0, score: d.score||0 })).sort((a,b) => b.totalScore-a.totalScore);
  const ul = document.getElementById('player-leaderboard');
  ul.innerHTML = '';
  sorted.slice(0, 6).forEach((p, i) => {
    const isMe = p.name === myName;
    const li = document.createElement('li'); li.className = 'lb-item'; li.style.animationDelay = (i*0.08)+'s';
    if (isMe) li.style.border = '2px solid var(--primary)';
    li.innerHTML = `<div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}${isMe?' <span style="font-size:0.7rem;color:var(--primary)">(æˆ‘)</span>':''}</div>
      <div class="lb-score">${p.totalScore.toLocaleString()}</div>
      ${p.score > 0 ? `<div class="lb-delta">+${p.score}</div>` : ''}`;
    ul.appendChild(li);
  });
  showScreen('screen-player-results');
}

async function showPlayerFinal(data) {
  shownFinal = true; clearInterval(pollTimer);
  const players = data?.players || {};
  const sorted = Object.entries(players).map(([name, d]) => ({ name, totalScore: d.totalScore||0 })).sort((a,b) => b.totalScore-a.totalScore);
  const myRank = sorted.findIndex(p => p.name === myName) + 1;
  const myData = players[myName] || { totalScore: 0 };
  const rankIcons = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('pfinal-rank-icon').textContent = myRank<=3 ? rankIcons[myRank-1] : 'ğŸ‰';
  document.getElementById('pfinal-score').textContent = (myData.totalScore||0).toLocaleString();
  document.getElementById('pfinal-rank').textContent = `æœ€çµ‚æ’åï¼šç¬¬ ${myRank} å`;
  document.getElementById('pfinal-msg').textContent = myRank===1 ? 'æ­å–œå¥ªå¾—ç¬¬ä¸€åï¼ğŸ†' : myRank<=3 ? 'è¡¨ç¾å„ªç•°ï¼' : 'æ„Ÿè¬åƒèˆ‡ï¼ç¹¼çºŒåŠ æ²¹ï¼';
  document.getElementById('pfinal-sub').textContent = `${myName} Â· éŠæˆ²çµæŸ`;
  const ul = document.getElementById('player-final-leaderboard');
  ul.innerHTML = '';
  sorted.forEach((p, i) => {
    const isMe = p.name === myName;
    const li = document.createElement('li'); li.className = 'lb-item'; li.style.animationDelay = (i*0.07)+'s';
    if (isMe) li.style.border = '2px solid var(--primary)';
    li.innerHTML = `<div class="lb-rank ${i===0?'top-1':i===1?'top-2':i===2?'top-3':''}">${rankLabel(i+1)}</div>
      <div class="player-avatar" style="background:${avatarColor(p.name)};flex-shrink:0">${initials(p.name)}</div>
      <div class="lb-name">${p.name}${isMe?' <span style="font-size:0.7rem;color:var(--primary)">(æˆ‘)</span>':''}</div>
      <div class="lb-score">${p.totalScore.toLocaleString()}</div>`;
    ul.appendChild(li);
  });
  showScreen('screen-player-final');
  if (myRank <= 3) launchConfetti();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  if (HARDCODED_TOKEN) {
    GITHUB_TOKEN = HARDCODED_TOKEN;
    setTokenStatus('ok', 'Token å·²è¼‰å…¥ âœ“');
  }
  // URL åƒæ•¸è‡ªå‹•å¸¶å…¥
  const params = new URLSearchParams(window.location.search);
  const roomParam = params.get('room');
  const gidParam  = params.get('gid');
  const tokParam  = params.get('t');
  if (tokParam) {
    _urlToken = decodeURIComponent(tokParam);
    // ç©å®¶ç«¯ä¹Ÿè¨­å®š GITHUB_TOKENï¼Œè®“ gistUpdate å¯ç”¨
    GITHUB_TOKEN = _urlToken;
  }
  if (roomParam && gidParam) {
    gistId = gidParam;
    saveRoomMapping(roomParam, gidParam);
    document.getElementById('room-code-input').value = roomParam;
    showScreen('screen-player-join');
  }
}

init();
</script>
</body>
</html>
